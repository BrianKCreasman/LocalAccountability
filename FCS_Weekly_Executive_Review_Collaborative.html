<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FCS Weekly Executive Review (Collaborative)</title>
  <style>
    :root{
      --black:#111111;
      --gray:#6b7280;
      --white:#ffffff;
      --gold:#dbd59b;
      --bg:#f5f5f7;
      --shadow:0 14px 36px rgba(0,0,0,0.14);
      --shadow-soft:0 10px 22px rgba(0,0,0,0.10);
      --radius:22px;
      --radius-sm:16px;
      --border:1px solid rgba(0,0,0,0.12);

      --green:#16a34a;
      --yellow:#f59e0b;
      --red:#dc2626;
      --blue:#2563eb;

      --school-bg: rgba(219,213,155,0.22);
      --school-border: rgba(0,0,0,0.16);

      --district-bg: rgba(37,99,235,0.10);
      --district-border: rgba(37,99,235,0.22);

      --purple:#6d28d9;
      --purple-soft: rgba(109,40,217,.10);
      --purple-border: rgba(109,40,217,.22);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--black);
    }

    .app{
      display:grid;
      grid-template-columns: 380px 1fr;
      min-height:100vh;
    }

    .sidebar{
      background: var(--white);
      border-right: var(--border);
      padding:18px 16px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow:auto;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:14px 12px 14px 12px;
      border-radius: var(--radius-sm);
      border: var(--border);
      background: linear-gradient(180deg, rgba(219,213,155,0.28), rgba(255,255,255,1));
      box-shadow: var(--shadow-soft);
      margin-bottom:14px;
      overflow:hidden;
    }

    /* Logo: remove the visible rectangle. This assumes your PNG has transparency.
       If your file has a white background baked in, you must replace it with a transparent PNG. */
    .brandLogoWrap{
      display:flex;
      justify-content:center;
      align-items:center;
      padding:6px 6px 0 6px;
    }
    .logoPlate{
      border-radius: 18px;
      padding:6px 8px;
      background: transparent; /* removed */
      border: none;           /* removed */
      box-shadow: none;       /* removed */
      display:flex;
      justify-content:center;
      align-items:center;
      width: 100%;
    }
    .brandLogo{
      max-width: 250px;
      width: 100%;
      height: auto;
      display:block;
      background: transparent;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,0.14));
    }

    .brand h1{ margin:0; font-size:16px; letter-spacing:0.2px; }
    .brand .sub{ font-size:12px; color: var(--gray); line-height:1.35; }

    label{ font-size:11px; color: var(--gray); }
    input[type="text"], input[type="date"], select, textarea{
      width:100%;
      border: var(--border);
      border-radius: 12px;
      padding:10px 10px;
      background: #fff;
      font-size:13px;
      outline:none;
    }
    textarea{ min-height: 92px; resize: vertical; }

    .meta{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin:12px 0 12px 0;
    }
    .meta .field{ display:flex; flex-direction:column; gap:6px; }
    .meta .span2{ grid-column: 1 / span 2; }

    .tools{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
    }
    .btn{
      border:none;
      border-radius: 14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      background: var(--black);
      color: var(--white);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .btn:hover{ transform: translateY(-2px); box-shadow: var(--shadow-soft); }
    .btn.secondary{
      background:#fff; color: var(--black);
      border: var(--border);
    }
    .btn.gold{ background: var(--gold); color: var(--black); }
    .btn.danger{ background: var(--red); color:#fff; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    .content{
      padding:22px 22px 44px 22px;
      overflow:auto;
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom:14px;
    }
    .topbar h2{ margin:0; font-size:18px; letter-spacing:0.2px; }
    .topbar .context{
      margin-top:4px;
      color: var(--gray);
      font-size:12px;
      line-height:1.35;
      max-width: 900px;
    }

    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; }

    .card{
      background: #fff;
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      padding:16px;
    }

    .cardHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:10px;
    }
    .card h3{ margin:0; font-size:14px; letter-spacing:0.2px; }
    .muted{ color: var(--gray); font-size:12px; line-height:1.35; }

    .summaryBar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .chip{
      border: var(--border);
      border-radius:999px;
      padding:8px 10px;
      background:#fff;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .statusDot{
      width:10px; height:10px; border-radius:99px;
      background: rgba(107,114,128,.5);
      box-shadow: 0 0 0 3px rgba(107,114,128,.12);
      flex:0 0 auto;
    }
    .statusDot.green{ background: var(--green); box-shadow: 0 0 0 3px rgba(22,163,74,.14); }
    .statusDot.yellow{ background: var(--yellow); box-shadow: 0 0 0 3px rgba(245,158,11,.16); }
    .statusDot.red{ background: var(--red); box-shadow: 0 0 0 3px rgba(220,38,38,.14); }

    .pill{
      font-size:11px;
      padding:5px 10px;
      border-radius:999px;
      border: var(--border);
      background:#fff;
      white-space:nowrap;
    }

    .laneRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }

    .qList{ display:flex; flex-direction:column; gap:10px; }

    .qItem{
      border: var(--border);
      border-radius: 16px;
      padding:12px;
      background: rgba(245,245,247,.6);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
      position:relative;
    }
    .qItem:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadow-soft);
      background: rgba(219,213,155,.18);
    }

    .qTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .qPrompt{
      font-size:13px;
      font-weight:800;
      line-height:1.35;
    }

    .checkWrap{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color: var(--gray);
      user-select:none;
      cursor:pointer;
    }
    .checkWrap input{ width:16px; height:16px; }

    .tip{
      font-size:11px;
      color: var(--gray);
      margin-top:6px;
      display:none;
    }
    .qItem:hover .tip{ display:block; }

    .roleStack{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .rolePanel{
      border-radius: 16px;
      padding:10px;
      border: 1px solid rgba(0,0,0,0.12);
      background: #fff;
      position: relative;
      overflow: hidden;
    }
    .roleHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .roleTitle{
      font-weight:900;
      font-size:12px;
      letter-spacing:0.2px;
    }
    .roleBadge{
      font-size:10px;
      font-weight:900;
      padding:6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.10);
      background:#fff;
      white-space:nowrap;
    }

    .rolePanel.school{ background: var(--school-bg); border-color: var(--school-border); }
    .rolePanel.district{ background: var(--district-bg); border-color: var(--district-border); }
    .rolePanel.school .roleBadge{ background: rgba(219,213,155,0.45); }
    .rolePanel.district .roleBadge{
      background: rgba(37,99,235,0.14);
      border-color: rgba(37,99,235,0.22);
    }

    .districtWrap{ margin-top: 8px; }
    .districtBanner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(37,99,235,0.35);
      background: rgba(37,99,235,0.08);
      margin-bottom: 10px;
    }
    .districtBanner .left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .districtBanner .title{
      font-weight:900;
      font-size:12px;
      color:#111;
      letter-spacing:0.2px;
    }
    .districtBanner .desc{
      font-size:11px;
      color: var(--gray);
      line-height:1.25;
    }
    .toggleLink{
      border: 1px solid rgba(37,99,235,0.25);
      background:#fff;
      border-radius: 999px;
      padding:8px 10px;
      font-weight:900;
      font-size:11px;
      cursor:pointer;
      white-space:nowrap;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .toggleLink:hover{ transform: translateY(-1px); box-shadow: var(--shadow-soft); }
    .districtBody.collapsed{ display:none; }

    .qAnswer{ width:100%; min-height: 110px; }

    .qActions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
      align-items:center;
    }

    .miniBtn{
      border: var(--border);
      background:#fff;
      border-radius: 14px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .miniBtn:hover{ transform: translateY(-1px); box-shadow: var(--shadow-soft); }
    .miniBtn.primary{
      background: var(--gold);
      border-color: rgba(0,0,0,0.15);
    }

    .artifactList{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .artifact{
      border: var(--border);
      background:#fff;
      border-radius: 14px;
      padding:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:12px;
    }
    .artifact a{ color: var(--blue); text-decoration:none; }
    .artifact a:hover{ text-decoration:underline; }
    .artifact .right{
      display:flex;
      gap:8px;
      align-items:center;
      flex:0 0 auto;
    }

    .inline{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .tableWrap{
      margin-top:10px;
      overflow:auto;
      border: var(--border);
      border-radius: 16px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th, td{
      text-align:left;
      padding:10px;
      border-bottom: var(--border);
      vertical-align:top;
    }
    thead{ background: rgba(245,245,247,.9); }

    .footerNote{
      margin-top:12px;
      color: var(--gray);
      font-size:11px;
      line-height:1.35;
    }

    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .laneRow{ grid-template-columns: 1fr; }
      .roleStack{ grid-template-columns: 1fr; }
    }

    @media print{
      .sidebar, .tools, .footerNote, .miniBtn, .toggleLink{ display:none !important; }
      body{ background:#fff; }
      .card{ box-shadow:none; }
      .districtBody.collapsed{ display:block !important; }
    }

    /* Evidence Modal */
    .modal.hidden { display: none; }
    .modal { position: fixed; inset: 0; z-index: 9999; }
    .modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.45); }
    .modal-card{
      position: relative;
      width: min(920px, calc(100vw - 32px));
      max-height: calc(100vh - 64px);
      overflow: auto;
      margin: 32px auto;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.22);
      border: 1px solid rgba(0,0,0,0.12);
    }
    .modal-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 16px;
      padding: 18px 18px 12px 18px;
      border-bottom: 1px solid rgba(0,0,0,0.10);
    }
    .modal-title{ font-size: 18px; font-weight: 900; color:#111; }
    .modal-subtitle{ font-size: 13px; color:#6b7280; margin-top: 2px; }
    .modal-body{ padding: 14px 18px 18px 18px; }

    .evidence-summary{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
    }
    .pillMini{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: #f5f5f7;
      border: 1px solid rgba(0,0,0,0.10);
      font-size: 12px;
      color: #111;
    }
    .evidence-list{ display:flex; flex-direction: column; gap: 10px; }
    .evidence-item{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.12);
      background: #fff;
    }
    .evidence-item .meta{ display:flex; flex-direction: column; gap: 4px; }
    .evidence-item .title{ font-weight: 900; color:#111; font-size: 14px; }
    .evidence-item .hint{ color:#6b7280; font-size: 12px; }
    .evidence-item a{ white-space: nowrap; text-decoration: none; }

    /* District drawer */
    .districtDetails{
      margin-top:10px;
      border-radius: 14px;
      border: 1px dashed rgba(109,40,217,.35);
      background: rgba(109,40,217,.06);
      overflow:hidden;
    }
    .districtDetails > summary{
      list-style:none;
      cursor:pointer;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-weight:900;
      font-size:12px;
      color:#111;
    }
    .districtDetails > summary::-webkit-details-marker{ display:none; }
    .districtDetails .sumLeft{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .purpleDotSmall{
      width:9px; height:9px; border-radius:99px;
      background:#6d28d9;
      box-shadow: 0 0 0 3px rgba(109,40,217,.14);
    }
    .districtDetails .sumHint{
      font-weight:700;
      font-size:11px;
      color: var(--gray);
    }
    .districtDetails .drawer{
      padding: 10px 12px 12px 12px;
      border-top: 1px solid rgba(109,40,217,.20);
      background: rgba(255,255,255,.75);
    }

    /* RYG rating chips */
    .ratingRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin: 8px 0 8px 0;
    }
    .ratingLabel{
      font-size:11px;
      color: var(--gray);
      font-weight:800;
    }
    .ratingSelect{
      width:auto;
      min-width: 170px;
      padding:8px 10px;
      border-radius: 999px;
      font-weight:900;
      font-size:12px;
    }
    .ratingSelect.green{ border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.10); }
    .ratingSelect.yellow{ border-color: rgba(245,158,11,.40); background: rgba(245,158,11,.12); }
    .ratingSelect.red{ border-color: rgba(220,38,38,.38); background: rgba(220,38,38,.10); }

    /* Sidebar analytics block (tight + clean) */
    details.analytics{
      margin-top:12px;
      border: var(--border);
      border-radius: var(--radius-sm);
      background: rgba(245,245,247,.55);
      box-shadow: var(--shadow-soft);
      overflow:hidden;
    }
    details.analytics > summary{
      list-style:none;
      cursor:pointer;
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-weight:900;
      font-size:12px;
      color:#111;
    }
    details.analytics > summary::-webkit-details-marker{ display:none; }
    .analyticsBody{
      padding: 10px 12px 12px 12px;
      border-top: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.85);
    }
    .miniGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .chartCard{
      border: 1px solid rgba(0,0,0,0.10);
      border-radius: 14px;
      padding:10px;
      background:#fff;
    }
    .chartTitle{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:6px;
    }
    .chartTitle .name{ font-weight:900; font-size:12px; }
    .chartTitle .hint{ font-size:11px; color: var(--gray); line-height:1.2; }
    canvas{ width:100%; height:120px; display:block; } /* tight height */
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="brandLogoWrap">
          <div class="logoPlate" aria-label="Compass logo">
            <!-- Replace this URL with a transparent PNG to fully remove any background -->
            <img class="brandLogo" src="https://i.postimg.cc/JhPCnwDT/Compass_Logo.png" alt="Compass Logo">
          </div>
        </div>
        <div>
          <h1>FCS Weekly Executive Review</h1>
          <div class="sub">Collaborative weekly discipline. Same questions. Better answers. Evidence first.</div>
        </div>
      </div>

      <div class="meta">
        <div class="field">
          <label for="weekOf">Week of</label>
          <input id="weekOf" type="date"/>
        </div>
        <div class="field">
          <label for="viewMode">View</label>
          <select id="viewMode">
            <option value="prep">Prep (Tue-Fri)</option>
            <option value="monday">Monday Review</option>
          </select>
        </div>

        <div class="field">
          <label for="orgLevel">Contributor</label>
          <select id="orgLevel">
            <option value="School">School</option>
            <option value="District">District</option>
          </select>
        </div>

        <div class="field" id="schoolField">
          <label for="schoolSelect">School</label>
          <select id="schoolSelect">
            <option value="Ewing ES">Ewing ES</option>
            <option value="Flemingsburg ES">Flemingsburg ES</option>
            <option value="Hillsboro ES">Hillsboro ES</option>
            <option value="Simons ES">Simons ES</option>
            <option value="Fleming Co. HS">Fleming Co. HS</option>
          </select>
        </div>

        <div class="field span2">
          <label for="weeklyFocus">Weekly focus area</label>
          <select id="weeklyFocus">
            <option value="vibrant_learning">Vibrant Learning (Real-World, Interdisciplinary Learning)</option>
            <option value="priority_standards">Priority Standards and Proficiency Scales</option>
            <option value="bim_workshop">BRIDGE Instructional Model (Workshop Model)</option>
            <option value="bpa">BRIDGE Performance Assessments (BPAs)</option>
            <option value="bpi_websites">BRIDGE Performance Indicators and Student BPI Websites</option>
            <option value="wac">Writing Across the Content (WAC)</option>
            <option value="compelling_evidence">Compelling Evidence and Local Accountability</option>
          </select>
        </div>

        <div class="field">
          <label for="submitterRole">Role</label>
          <select id="submitterRole">
            <option value="Principal">Principal</option>
            <option value="District Leader">District Leader</option>
            <option value="Director">Director</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="field">
          <label for="submitterName">Name</label>
          <input id="submitterName" type="text" placeholder="First Last"/>
        </div>
      </div>

      <div class="tools">
        <button class="btn gold" id="saveLocalBtn">Save local</button>
        <button class="btn secondary" id="printBtn">Print</button>
        <button class="btn secondary" id="exportBtn">Export JSON</button>
        <label class="btn secondary" style="display:inline-flex; align-items:center; gap:8px;">
          Import JSON
          <input id="importFile" type="file" accept="application/json" style="display:none;">
        </label>
        <button class="btn danger" id="resetBtn">Reset</button>
      </div>

      <div class="tools">
        <button class="btn" id="submitToSheetBtn">Submit to Google Sheet</button>
        <button class="btn secondary" id="refreshTrendsBtn">Refresh trends</button>
      </div>

      <!-- Animated charts live UNDER the left submit buttons -->
      <details class="analytics" id="analyticsBlock" open>
        <summary>
          <span>Analytics (Selected School vs District)</span>
          <span class="pill" id="analyticsPill">No data</span>
        </summary>
        <div class="analyticsBody">
          <div class="miniGrid">
            <div class="chartCard">
              <div class="chartTitle">
                <div>
                  <div class="name">Status score</div>
                  <div class="hint">Current week vs YTD (avg)</div>
                </div>
                <div class="pill" id="statusLegendPill">G=3 Y=2 R=1</div>
              </div>
              <canvas id="barStatus"></canvas>
            </div>

            <div class="chartCard">
              <div class="chartTitle">
                <div>
                  <div class="name">Core question ratings</div>
                  <div class="hint">Distribution (School + District)</div>
                </div>
                <div class="pill" id="coreLegendPill">RYG</div>
              </div>
              <canvas id="pieCore"></canvas>
            </div>
          </div>

          <div class="footerNote" style="margin-top:10px;">
            These charts update when you change School, Week, Focus Area, or refresh trends.
          </div>
        </div>
      </details>

      <div class="footerNote">
        Rule: Yellow or Red requires a clear plan, owner, due date, and help needed.
      </div>
    </aside>

    <main class="content">
      <div class="topbar">
        <div>
          <h2 id="pageTitle">Loading...</h2>
          <div class="context" id="pageContext"></div>
          <div class="summaryBar" id="summaryBar"></div>
        </div>

        <div style="min-width:280px;">
          <div class="card" style="padding:14px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
              <div>
                <div style="font-weight:900; font-size:13px;">Lane Status</div>
                <div class="muted">Overall weekly focus status (must match evidence).</div>
              </div>
              <div class="pill" id="completionPill">0% complete</div>
            </div>

            <div class="inline" style="margin-top:10px;">
              <span class="statusDot" id="statusDot"></span>
              <select id="statusSelect">
                <option value="green">Green (on track)</option>
                <option value="yellow">Yellow (at risk, plan in place)</option>
                <option value="red">Red (off track, need help)</option>
              </select>
            </div>

            <div class="laneRow" style="margin-top:10px;">
              <div>
                <label>Key metric 1</label>
                <input id="metric1" type="text" placeholder="Example: % evidence updated"/>
              </div>
              <div>
                <label>Key metric 2</label>
                <input id="metric2" type="text" placeholder="Example: calibration done"/>
              </div>
              <div>
                <label>Key metric 3</label>
                <input id="metric3" type="text" placeholder="Example: WAC artifacts published"/>
              </div>
            </div>

            <div style="margin-top:10px;">
              <label>Lane owner</label>
              <input id="laneOwner" type="text" placeholder="Name"/>
            </div>

            <div class="muted" style="margin-top:10px;">
              Tip: District panels auto-collapse for School contributors. District comment drawers open only when needed.
            </div>
          </div>
        </div>
      </div>

      <div class="grid">
        <section class="card">
          <div class="cardHeader">
            <div>
              <h3>Core Framing Questions (Every Area, Every Week)</h3>
              <div class="muted">Now includes School and District RYG ratings on every core question.</div>
            </div>
            <div class="pill" id="coreDonePill">0/0 answered</div>
          </div>
          <div class="qList" id="coreQuestions"></div>
        </section>

        <section class="card">
          <div class="cardHeader">
            <div>
              <h3 id="focusTitle">Focus Area Questions</h3>
              <div class="muted" id="focusHint"></div>
            </div>
            <div class="pill" id="focusDonePill">0/0 answered</div>
          </div>
          <div class="qList" id="focusQuestions"></div>
        </section>

        <section class="card">
          <div class="cardHeader">
            <div>
              <h3>Closing Mulally Question (Always Last)</h3>
              <div class="muted">If this is fuzzy, the system is not aligned yet.</div>
            </div>
            <div class="pill" id="closeDonePill">Not answered</div>
          </div>
          <div class="qList" id="closingQuestion"></div>
        </section>

        <section class="card">
          <div class="cardHeader">
            <div>
              <h3>Trends and rollups (from Google Sheet)</h3>
              <div class="muted">Filter by org level and date range. Table includes an Evidence viewer.</div>
            </div>
            <div class="pill">Green=3, Yellow=2, Red=1</div>
          </div>

          <div class="laneRow">
            <div>
              <label>Trends: Org level</label>
              <select id="trendOrgLevel">
                <option value="all">All</option>
                <option value="School">School</option>
                <option value="District">District</option>
              </select>
            </div>
            <div>
              <label>Trends: From</label>
              <input id="dateFrom" type="date"/>
            </div>
            <div>
              <label>Trends: To</label>
              <input id="dateTo" type="date"/>
            </div>
          </div>

          <div class="laneRow" style="margin-top:10px;">
            <div class="chip"><span class="statusDot"></span><span>Weekly: <b id="rollupWeekly">No data</b></span></div>
            <div class="chip"><span class="statusDot"></span><span>Monthly: <b id="rollupMonthly">No data</b></span></div>
            <div class="chip"><span class="statusDot"></span><span>YTD: <b id="rollupYtd">No data</b></span></div>
          </div>

          <div class="tableWrap">
            <table>
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Org</th>
                  <th>School</th>
                  <th>Focus Area</th>
                  <th>Status</th>
                  <th>Metric 1</th>
                  <th>Metric 2</th>
                  <th>Metric 3</th>
                  <th>Evidence</th>
                </tr>
              </thead>
              <tbody id="trendsTableBody"></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Evidence Modal -->
  <div id="evidenceModal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop" onclick="closeEvidenceModal()"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="evidenceTitle">
      <div class="modal-header">
        <div>
          <div id="evidenceTitle" class="modal-title">Evidence</div>
          <div id="evidenceSubtitle" class="modal-subtitle"></div>
        </div>
        <button class="btn secondary" onclick="closeEvidenceModal()">Close</button>
      </div>
      <div class="modal-body">
        <div id="evidenceSummary" class="evidence-summary"></div>
        <div id="evidenceList" class="evidence-list"></div>
        <div class="footerNote" style="margin-top:12px;">
          Note: This list shows links saved in the submission (uploaded artifacts and pasted links).
        </div>
      </div>
    </div>
  </div>

<script>
  // =========================
  // CONFIG
  // =========================
  const SCRIPT_URL = "https://script.google.com/a/macros/fleming.kyschools.us/s/AKfycbzNVN8AiQzPBzE1CMdDzy9bWGzlq9_p4qALlzwuEDkUxIzazgIHK70pS61nswTX0T_B6w/exec";
  const STORAGE_KEY = "fcs_weekly_exec_review_collab_v4_charts_core_ratings";

  const AUTO_COLLAPSE_DISTRICT_FOR_SCHOOL = true;

  // =========================
  // QUESTIONS
  // =========================
  const CORE_FRAMING_QUESTIONS = [
    { id:"plan", prompt:"What is the plan for this area of focus? If the plan cannot be stated in two to three sentences, it is not clear enough yet.", tip:"Write it as a tight plan statement. If it is long, it is not clear yet." },
    { id:"happened", prompt:"What actually happened this week? Not what was intended, not what is usually true. What evidence shows what students and classrooms experienced.", tip:"Name specific evidence. Student work, walkthrough notes, BPI artifacts, BPA products, WAC samples." },
    { id:"status_why", prompt:"Are we on track, at risk, or off track? Why? Status must be tied directly to observable evidence, not perception.", tip:"If you cannot cite evidence, stay Yellow until the evidence is real." },
    { id:"threat", prompt:"What is the one thing that most threatens progress right now? This keeps the conversation from drifting into laundry lists.", tip:"One thing. Not five." },
    { id:"address", prompt:"What is the plan to address it? Who owns it, what is changing next week, and how will we know it worked.", tip:"Owner + next step + success signal." },
    { id:"help", prompt:"Where do you need help? Leaders are expected to ask for help early, not after failure.", tip:"Be explicit: decision needed, support needed, barrier removal." }
  ];

  const CLOSING_QUESTION = {
    id:"closing",
    prompt:"If we sit here next Monday, what would have to change for you to confidently say we are moving forward?",
    tip:"Say what must be different in observable terms."
  };

  const FOCUS_META = {
    vibrant_learning: { title:"Vibrant Learning (Real-World, Interdisciplinary Learning)", hint:"Ask if learning is visible and aligned, not if it feels good." },
    priority_standards: { title:"Priority Standards and Proficiency Scales", hint:"Alignment to the plan and clarity of expectations." },
    bim_workshop: { title:"BRIDGE Instructional Model (Workshop Model)", hint:"Process discipline. Visible steps. Evidence in student work." },
    bpa: { title:"BRIDGE Performance Assessments (BPAs)", hint:"Results must match intent. Calibrate quality and expectations." },
    bpi_websites: { title:"BRIDGE Performance Indicators and Student BPI Websites", hint:"Visibility of growth, mastery, readiness, and story." },
    wac: { title:"Writing Across the Content (WAC)", hint:"Writing deepens thinking and makes learning transferable." },
    compelling_evidence: { title:"Compelling Evidence and Local Accountability", hint:"This keeps the system honest and coherent." }
  };

  const FOCUS_QUESTIONS = {
    vibrant_learning: [
      { id:"rw_context", prompt:"Where did students apply learning to a real-world context this week?", tip:"Name the real context and the student product." },
      { id:"thinking_evidence", prompt:"What evidence shows students were thinking, not just completing tasks?", tip:"Look for reasoning, explanation, revision, transfer." },
      { id:"bright_spots", prompt:"Which classrooms best represent our vision of vibrant learning right now?", tip:"Name the bright spots and what we can learn from them." },
      { id:"transactional", prompt:"Where is learning still too transactional, and why?", tip:"Name the condition, not the person." },
      { id:"adjustment", prompt:"What is one adjustment you are making next week to increase relevance or depth?", tip:"One adjustment, then watch for one signal." }
    ],
    priority_standards: [
      { id:"visible_standards", prompt:"Which priority standards were most visible in classrooms this week?", tip:"Name 1-3 standards and where they showed up." },
      { id:"mastery_evidence", prompt:"How do we know students were working toward mastery of those standards?", tip:"Cite evidence. What did students do that proves it." },
      { id:"scale_clarity", prompt:"Where are proficiency scales helping clarify expectations for students?", tip:"Where did students self-assess or reference the scale." },
      { id:"scale_gap", prompt:"Where are they still not shaping instruction or assessment?", tip:"Name the gap and why it is happening." },
      { id:"student_explain", prompt:"What evidence shows students can explain where they are on the scale?", tip:"Student explanation is the signal, not teacher opinion." }
    ],
    bim_workshop: [
      { id:"model_visible", prompt:"Where did the Workshop Model clearly drive learning this week?", tip:"Point to mini-lesson, workshop, conferring, debrief evidence." },
      { id:"mini_lesson_align", prompt:"What evidence shows mini-lessons were aligned to priority standards?", tip:"Alignment is visible in target, task, and feedback." },
      { id:"workshop_use", prompt:"How did workshop time allow students to practice, apply, or create?", tip:"Practice is not just worksheets. Look for application." },
      { id:"breakdown", prompt:"Where did the model break down, and what caused it?", tip:"Name the condition and the cause so it can be fixed." },
      { id:"fidelity_adjust", prompt:"What is one concrete adjustment being made to strengthen fidelity?", tip:"One change next week, and one signal you will check." }
    ],
    bpa: [
      { id:"in_progress", prompt:"Which BPAs were in progress or completed this week?", tip:"Name the BPA(s) and where they are in the process." },
      { id:"multiple_ways", prompt:"How do these assessments allow students to demonstrate learning in multiple ways?", tip:"Show choice, pathways, modalities, durable skills." },
      { id:"alignment", prompt:"What evidence shows alignment to standards and durable skills?", tip:"Rubric and student products must match the standards." },
      { id:"project_vs_assess", prompt:"Where are BPAs still feeling like 'projects' instead of assessments?", tip:"Look for unclear criteria, weak alignment, or missing feedback loops." },
      { id:"support_needed", prompt:"What support is needed to strengthen quality or consistency?", tip:"Calibration, exemplars, rubric tuning, coaching, time." }
    ],
    bpi_websites: [
      { id:"new_evidence", prompt:"What new evidence was added to student BPI websites this week?", tip:"Name what was added and what it shows." },
      { id:"growth_over_time", prompt:"How does that evidence show growth, mastery, or readiness over time?", tip:"Compare over time, not a single artifact." },
      { id:"storytelling", prompt:"Where are students telling their learning story clearly?", tip:"Student voice matters. Look for clarity and reflection." },
      { id:"thin_evidence", prompt:"Where is evidence thin, unclear, or missing?", tip:"Name the evidence gaps so next steps are obvious." },
      { id:"quality_plan", prompt:"What is the plan to improve evidence quality next week?", tip:"What will be uploaded, by whom, by when, with what quality bar." }
    ],
    wac: [
      { id:"explain_thinking", prompt:"Where did students write to explain thinking, not just respond?", tip:"Look for explanation, justification, and reasoning." },
      { id:"deepen_understanding", prompt:"What evidence shows writing deepened understanding of content?", tip:"Writing should improve thinking, not just record it." },
      { id:"authentic_comm", prompt:"How are students using writing to communicate learning authentically?", tip:"Audience, purpose, revision, publishing are strong signals." },
      { id:"add_on", prompt:"Where is writing still treated as an add-on?", tip:"Name the barrier and the condition causing it." },
      { id:"next_shift", prompt:"What shift will be made next week to strengthen writing as a learning tool?", tip:"One shift, one signal." }
    ],
    compelling_evidence: [
      { id:"best_evidence", prompt:"What evidence best represents the reality of learning this week?", tip:"Pick the evidence that tells the truth, not the most flattering." },
      { id:"assumptions", prompt:"What assumptions were challenged by actual student work?", tip:"Name what you thought and what the evidence showed." },
      { id:"same_story", prompt:"Where do dashboards, walkthroughs, and artifacts tell the same story?", tip:"Alignment across sources builds trust." },
      { id:"conflict", prompt:"Where do they conflict, and why?", tip:"Conflicts are gifts. They show where the system is unclear." },
      { id:"next_lookfors", prompt:"What will we look for next week to confirm progress?", tip:"Be specific. Define the next signal." }
    ]
  };

  // =========================
  // STATE + MIGRATION
  // =========================
  function blankRoleAnswer(){
    return { text:"", checked:false, notes:"", artifacts:[], rating:"" }; // rating: green/yellow/red
  }

  function defaultState(){
    const today = new Date();
    const iso = new Date(today.getTime() - today.getTimezoneOffset()*60000).toISOString().slice(0,10);

    return {
      meta: {
        weekOf: iso,
        viewMode: "prep",
        orgLevel: "School",
        school: "Fleming Co. HS",
        submitterRole: "Principal",
        submitterName: "",
        weeklyFocus: "vibrant_learning"
      },
      status: {
        status: "green",
        metric1: "",
        metric2: "",
        metric3: "",
        laneOwner: ""
      },
      answers: {
        core: {},
        focus: {},
        closing: {}
      },
      _districtExpandMap: {}
    };
  }

  let districtExpandMap = {};
  let state = loadState();

  function migrateRoleAnswer(roleObj){
    const base = blankRoleAnswer();
    if(!roleObj || typeof roleObj !== "object") return base;
    return { ...base, ...roleObj, artifacts: Array.isArray(roleObj.artifacts) ? roleObj.artifacts : [] };
  }

  function migrateOldAnswerShape(obj){
    if(!obj || typeof obj !== "object") return null;

    const hasRole = (obj.school && obj.district);
    if(hasRole){
      return {
        school: migrateRoleAnswer(obj.school),
        district: migrateRoleAnswer(obj.district)
      };
    }

    const looksOld = ("text" in obj) || ("checked" in obj) || ("notes" in obj) || ("artifacts" in obj) || ("rating" in obj);
    if(looksOld){
      return {
        school: migrateRoleAnswer(obj),
        district: blankRoleAnswer()
      };
    }

    return {
      school: migrateRoleAnswer(obj.school),
      district: migrateRoleAnswer(obj.district)
    };
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) {
        const s = defaultState();
        districtExpandMap = s._districtExpandMap || {};
        return s;
      }
      const parsed = JSON.parse(raw);
      const merged = { ...defaultState(), ...parsed };

      ["core","focus","closing"].forEach(bucket => {
        merged.answers[bucket] = merged.answers[bucket] || {};
        Object.keys(merged.answers[bucket]).forEach(qid => {
          merged.answers[bucket][qid] = migrateOldAnswerShape(merged.answers[bucket][qid]) || {
            school: blankRoleAnswer(),
            district: blankRoleAnswer()
          };
        });
      });

      districtExpandMap = merged._districtExpandMap || {};
      return merged;
    }catch(e){
      const s = defaultState();
      districtExpandMap = {};
      return s;
    }
  }

  function saveState(){
    state._districtExpandMap = districtExpandMap;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    // update charts from local changes too
    requestAnalyticsUpdate("local");
  }

  // =========================
  // HELPERS
  // =========================
  function escapeHtml(str){
    return String(str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function statusToScore(status){
    const s = (status || "").toLowerCase();
    if(s === "green") return 3;
    if(s === "yellow") return 2;
    if(s === "red") return 1;
    return 0;
  }

  function statusClass(s){
    if(s === "green") return "green";
    if(s === "yellow") return "yellow";
    if(s === "red") return "red";
    return "";
  }

  function updateStatusDot(){
    const dot = document.getElementById("statusDot");
    dot.className = "statusDot " + statusClass(state.status.status);
  }

  function setSchoolVisibility(){
    const org = document.getElementById("orgLevel").value;
    const schoolField = document.getElementById("schoolField");
    schoolField.style.display = (org === "School") ? "block" : "none";
  }

  function isDistrictContributor(){
    return (state.meta.orgLevel || "").toLowerCase() === "district";
  }

  function districtKey(bucket, qid){
    return `${bucket}:${qid}`;
  }

  function isDistrictExpanded(bucket, qid){
    if(isDistrictContributor()) return true;
    const key = districtKey(bucket, qid);
    if(typeof districtExpandMap[key] === "boolean") return districtExpandMap[key];
    return false;
  }

  function setDistrictExpanded(bucket, qid, expanded){
    districtExpandMap[districtKey(bucket, qid)] = !!expanded;
    saveState();
  }

  function ensureRoleAnswer(bucket, qid){
    if(!state.answers[bucket][qid]){
      state.answers[bucket][qid] = { school: blankRoleAnswer(), district: blankRoleAnswer() };
      return state.answers[bucket][qid];
    }
    state.answers[bucket][qid] = migrateOldAnswerShape(state.answers[bucket][qid]) || {
      school: blankRoleAnswer(),
      district: blankRoleAnswer()
    };
    return state.answers[bucket][qid];
  }

  function getRoleAnswer(bucket, qid, role){
    const a = ensureRoleAnswer(bucket, qid);
    return a[role];
  }

  function districtHasAnyContent(bucket, qid){
    const d = getRoleAnswer(bucket, qid, "district");
    const hasText = (d.text || "").trim().length > 0;
    const hasNote = (d.notes || "").trim().length > 0;
    const hasArtifacts = Array.isArray(d.artifacts) && d.artifacts.length > 0;
    const hasChecked = !!d.checked;
    const hasRating = !!(d.rating || "").trim();
    return hasText || hasNote || hasArtifacts || hasChecked || hasRating;
  }

  function setDistrictDetailsAutoOpen(bucket, qid){
    const det = document.getElementById(`${bucket}_${qid}_districtDetails`);
    if(!det) return;
    det.open = isDistrictContributor() || districtHasAnyContent(bucket, qid);
  }

  // =========================
  // RENDER QUESTIONS
  // =========================
  function renderQuestionList(containerId, bucket, questions, withRatings){
    const container = document.getElementById(containerId);
    container.innerHTML = "";

    questions.forEach(q => {
      ensureRoleAnswer(bucket, q.id);

      const expanded = isDistrictExpanded(bucket, q.id);
      const collapseClass = expanded ? "" : "collapsed";

      const ratingBlockSchool = withRatings ? `
        <div class="ratingRow">
          <span class="ratingLabel">Rating:</span>
          <select class="ratingSelect" data-bucket="${bucket}" data-qid="${q.id}" data-role="school" data-field="rating">
            <option value="">Select</option>
            <option value="green">Green</option>
            <option value="yellow">Yellow</option>
            <option value="red">Red</option>
          </select>
        </div>
      ` : "";

      const ratingBlockDistrict = withRatings ? `
        <div class="ratingRow">
          <span class="ratingLabel">Rating:</span>
          <select class="ratingSelect" data-bucket="${bucket}" data-qid="${q.id}" data-role="district" data-field="rating">
            <option value="">Select</option>
            <option value="green">Green</option>
            <option value="yellow">Yellow</option>
            <option value="red">Red</option>
          </select>
        </div>
      ` : "";

      const el = document.createElement("div");
      el.className = "qItem";
      el.innerHTML = `
        <div class="qTop">
          <div>
            <div class="qPrompt">${escapeHtml(q.prompt)}</div>
            <div class="tip">Tip: ${escapeHtml(q.tip || "")}</div>
          </div>
        </div>

        <div class="roleStack">
          <!-- SCHOOL -->
          <div class="rolePanel school">
            <div class="roleHeader">
              <div>
                <div class="roleTitle">School Leader</div>
                <div class="muted">What you saw and what students produced this week.</div>
              </div>
              <div class="roleBadge">SCHOOL</div>
            </div>

            ${ratingBlockSchool}

            <label class="checkWrap" title="Mark as clear and evidence-backed">
              <input type="checkbox"
                data-bucket="${bucket}" data-qid="${q.id}" data-role="school" data-field="checked"/>
              Clear
            </label>

            <textarea class="qAnswer"
              data-bucket="${bucket}" data-qid="${q.id}" data-role="school" data-field="text"
              placeholder="School leader response (evidence-backed specifics)."></textarea>

            <div class="qActions">
              <button class="miniBtn" data-action="addNote" data-bucket="${bucket}" data-qid="${q.id}" data-role="school">Add note</button>

              <button class="miniBtn primary" data-action="addLink" data-bucket="${bucket}" data-qid="${q.id}" data-role="school">
                Add artifact link
              </button>

              <label class="miniBtn primary" style="display:inline-flex; align-items:center; gap:8px;">
                Upload artifact
                <input type="file" style="display:none;" data-action="upload" data-bucket="${bucket}" data-qid="${q.id}" data-role="school"/>
              </label>

              <span class="muted" id="${bucket}_${q.id}_school_noteHint"></span>
            </div>

            <div class="artifactList" id="${bucket}_${q.id}_school_artifacts"></div>
          </div>

          <!-- DISTRICT -->
          <div class="rolePanel district">
            <div class="districtWrap">
              <div class="districtBanner">
                <div class="left">
                  <div class="title">District panel exists</div>
                  <div class="desc">Used for validation, patterns, supports, and barrier removal.</div>
                </div>
                <button class="toggleLink"
                  type="button"
                  data-action="toggleDistrict"
                  data-bucket="${bucket}"
                  data-qid="${q.id}">
                  ${expanded ? "Hide District" : "Show District"}
                </button>
              </div>

              <div class="districtBody ${collapseClass}" id="${bucket}_${q.id}_districtBody">

                <details class="districtDetails" id="${bucket}_${q.id}_districtDetails">
                  <summary>
                    <div class="sumLeft">
                      <span class="purpleDotSmall"></span>
                      <span>District leader comment (optional)</span>
                      <span class="sumHint">Expand only if needed</span>
                    </div>
                    <span class="toggleLink" style="padding:6px 10px; border-color: rgba(109,40,217,.25);">Open</span>
                  </summary>

                  <div class="drawer">
                    <div class="roleHeader" style="margin-bottom:6px;">
                      <div>
                        <div class="roleTitle">District Leader</div>
                        <div class="muted">Validation, patterns, supports, barrier removal.</div>
                      </div>
                      <div class="roleBadge" style="background: rgba(109,40,217,.14); border-color: rgba(109,40,217,.22);">DISTRICT</div>
                    </div>

                    ${ratingBlockDistrict}

                    <label class="checkWrap" title="Mark as clear and evidence-backed">
                      <input type="checkbox"
                        data-bucket="${bucket}" data-qid="${q.id}" data-role="district" data-field="checked"/>
                      Clear
                    </label>

                    <textarea class="qAnswer"
                      data-bucket="${bucket}" data-qid="${q.id}" data-role="district" data-field="text"
                      placeholder="District leader comment (only if needed)."></textarea>

                    <div class="qActions">
                      <button class="miniBtn" data-action="addNote" data-bucket="${bucket}" data-qid="${q.id}" data-role="district">Add note</button>

                      <button class="miniBtn primary" data-action="addLink" data-bucket="${bucket}" data-qid="${q.id}" data-role="district">
                        Add artifact link
                      </button>

                      <label class="miniBtn primary" style="display:inline-flex; align-items:center; gap:8px;">
                        Upload artifact
                        <input type="file" style="display:none;" data-action="upload" data-bucket="${bucket}" data-qid="${q.id}" data-role="district"/>
                      </label>

                      <span class="muted" id="${bucket}_${q.id}_district_noteHint"></span>
                    </div>

                    <div class="artifactList" id="${bucket}_${q.id}_district_artifacts"></div>
                  </div>
                </details>

              </div>
            </div>
          </div>
        </div>
      `;

      container.appendChild(el);

      hydrateRolePanel(bucket, q.id, "school", el, withRatings);
      hydrateRolePanel(bucket, q.id, "district", el, withRatings);

      renderArtifacts(bucket, q.id, "school");
      renderArtifacts(bucket, q.id, "district");

      setDistrictDetailsAutoOpen(bucket, q.id);
      wireQuestionEvents(el, withRatings);
    });

    updateAnsweredPills();
    updateCompletion();
  }

  function hydrateRolePanel(bucket, qid, role, scopeEl, withRatings){
    const a = getRoleAnswer(bucket, qid, role);

    const chk = scopeEl.querySelector(`input[type="checkbox"][data-bucket="${bucket}"][data-qid="${qid}"][data-role="${role}"][data-field="checked"]`);
    if(chk) chk.checked = !!a.checked;

    const ta = scopeEl.querySelector(`textarea[data-bucket="${bucket}"][data-qid="${qid}"][data-role="${role}"][data-field="text"]`);
    if(ta) ta.value = a.text || "";

    if(withRatings){
      const rs = scopeEl.querySelector(`select[data-bucket="${bucket}"][data-qid="${qid}"][data-role="${role}"][data-field="rating"]`);
      if(rs){
        rs.value = a.rating || "";
        rs.classList.remove("green","yellow","red");
        if(a.rating) rs.classList.add(a.rating);
      }
    }

    const hint = document.getElementById(`${bucket}_${qid}_${role}_noteHint`);
    if(hint) hint.textContent = a.notes ? "Note added" : "";
  }

  function renderArtifacts(bucket, qid, role){
    const a = getRoleAnswer(bucket, qid, role);
    const list = document.getElementById(`${bucket}_${qid}_${role}_artifacts`);
    if(!list) return;

    list.innerHTML = "";
    (a.artifacts || []).forEach((art, idx) => {
      const row = document.createElement("div");
      row.className = "artifact";
      const label = art.label || art.name || "Artifact";
      const linkHtml = art.url ? `<a href="${escapeHtml(art.url)}" target="_blank" rel="noopener">${escapeHtml(label)}</a>` : escapeHtml(label);

      row.innerHTML = `
        <div>
          <div style="font-weight:900;">${linkHtml}</div>
          <div class="muted">${escapeHtml(art.kind || "")}${art.kind ? " | " : ""}${escapeHtml(art.note || "")}</div>
        </div>
        <div class="right">
          <button class="miniBtn"
            data-action="removeArtifact" data-bucket="${bucket}" data-qid="${qid}" data-role="${role}" data-idx="${idx}">
            Remove
          </button>
        </div>
      `;
      list.appendChild(row);
    });
  }

  function wireQuestionEvents(scopeEl, withRatings){
    // inputs/textarea/select (data-field)
    scopeEl.querySelectorAll("[data-field]").forEach(el => {
      const bucket = el.getAttribute("data-bucket");
      const qid = el.getAttribute("data-qid");
      const role = el.getAttribute("data-role");
      const field = el.getAttribute("data-field");

      const handler = () => {
        const a = getRoleAnswer(bucket, qid, role);
        if(field === "checked"){
          a.checked = !!el.checked;
        }else if(field === "text"){
          a.text = el.value || "";
        }else if(field === "rating"){
          a.rating = el.value || "";
          el.classList.remove("green","yellow","red");
          if(a.rating) el.classList.add(a.rating);
        }

        saveState();

        if(role === "district"){
          setDistrictDetailsAutoOpen(bucket, qid);
        }

        updateAnsweredPills();
        updateCompletion();
      };

      const evt = (field === "text") ? "input" : "change";
      el.addEventListener(evt, handler);
    });

    // actions
    scopeEl.querySelectorAll("[data-action]").forEach(el => {
      const action = el.getAttribute("data-action");
      const bucket = el.getAttribute("data-bucket");
      const qid = el.getAttribute("data-qid");
      const role = el.getAttribute("data-role");

      if(action === "toggleDistrict"){
        el.addEventListener("click", () => {
          if(isDistrictContributor()) return;

          const body = document.getElementById(`${bucket}_${qid}_districtBody`);
          if(!body) return;

          const currentlyCollapsed = body.classList.contains("collapsed");
          if(currentlyCollapsed){
            body.classList.remove("collapsed");
            el.textContent = "Hide District";
            setDistrictExpanded(bucket, qid, true);
          }else{
            body.classList.add("collapsed");
            el.textContent = "Show District";
            setDistrictExpanded(bucket, qid, false);
          }
        });
      }

      if(action === "addNote"){
        el.addEventListener("click", () => {
          const a = getRoleAnswer(bucket, qid, role);
          const next = prompt("Add a short note (context, names, reminders):", a.notes || "");
          if(next === null) return;
          a.notes = next.trim();
          saveState();

          const hint = document.getElementById(`${bucket}_${qid}_${role}_noteHint`);
          if(hint) hint.textContent = a.notes ? "Note added" : "";

          if(role === "district") setDistrictDetailsAutoOpen(bucket, qid);
        });
      }

      if(action === "addLink"){
        el.addEventListener("click", () => {
          const a = getRoleAnswer(bucket, qid, role);
          const url = prompt("Paste an artifact link (Drive link, BPI page, rubric, student product URL):", "");
          if(!url) return;
          const label = prompt("Short label (example: 'BPI sample: Grade 7', 'BPA rubric', 'WAC published piece'):", "Artifact");
          a.artifacts.push({ kind:"link", url: url.trim(), label: (label || "Artifact").trim(), note:"" });
          saveState();
          renderArtifacts(bucket, qid, role);

          if(role === "district") setDistrictDetailsAutoOpen(bucket, qid);
        });
      }

      if(action === "upload"){
        el.addEventListener("change", async (evt) => {
          const file = evt.target.files && evt.target.files[0];
          evt.target.value = "";
          if(!file) return;

          try{
            const a = getRoleAnswer(bucket, qid, role);
            const uploaded = await uploadArtifactToDrive(file);
            a.artifacts.push({
              kind: "upload",
              url: uploaded.url,
              label: uploaded.name || file.name,
              note: uploaded.note || ""
            });

            saveState();
            renderArtifacts(bucket, qid, role);

            if(role === "district") setDistrictDetailsAutoOpen(bucket, qid);

            alert("Uploaded and linked.");
          }catch(err){
            alert("Upload failed: " + String(err));
          }
        });
      }

      if(action === "removeArtifact"){
        el.addEventListener("click", () => {
          const idx = Number(el.getAttribute("data-idx"));
          const a = getRoleAnswer(bucket, qid, role);
          a.artifacts.splice(idx, 1);
          saveState();
          renderArtifacts(bucket, qid, role);

          if(role === "district") setDistrictDetailsAutoOpen(bucket, qid);
        });
      }
    });
  }

  // =========================
  // COMPLETION
  // =========================
  function countAnswered(bucket, questions){
    let answered = 0;
    questions.forEach(q => {
      const school = getRoleAnswer(bucket, q.id, "school");
      const district = getRoleAnswer(bucket, q.id, "district");
      const hasAnyText = (school.text || "").trim().length > 0 || (district.text || "").trim().length > 0;
      if(hasAnyText) answered += 1;
    });
    return { answered, total: questions.length };
  }

  function updateAnsweredPills(){
    const core = countAnswered("core", CORE_FRAMING_QUESTIONS);
    document.getElementById("coreDonePill").textContent = `${core.answered}/${core.total} answered`;

    const focusId = state.meta.weeklyFocus;
    const focusQs = FOCUS_QUESTIONS[focusId] || [];
    const focus = countAnswered("focus", focusQs);
    document.getElementById("focusDonePill").textContent = `${focus.answered}/${focus.total} answered`;

    const closingSchool = getRoleAnswer("closing", "closing", "school");
    const closingDistrict = getRoleAnswer("closing", "closing", "district");
    const closingAnswered = (closingSchool.text || "").trim().length || (closingDistrict.text || "").trim().length;
    document.getElementById("closeDonePill").textContent = closingAnswered ? "Answered" : "Not answered";
  }

  function updateCompletion(){
    const focusId = state.meta.weeklyFocus;
    const focusQs = FOCUS_QUESTIONS[focusId] || [];

    const core = countAnswered("core", CORE_FRAMING_QUESTIONS);
    const focus = countAnswered("focus", focusQs);

    const closingSchool = getRoleAnswer("closing", "closing", "school");
    const closingDistrict = getRoleAnswer("closing", "closing", "district");
    const closingAnswered = ((closingSchool.text || "").trim().length || (closingDistrict.text || "").trim().length) ? 1 : 0;

    const total = core.total + focus.total + 1;
    const done = core.answered + focus.answered + closingAnswered;

    const pct = total ? Math.round((done/total)*100) : 0;
    document.getElementById("completionPill").textContent = `${pct}% complete`;
  }

  // =========================
  // SUMMARY BAR
  // =========================
  function renderSummaryBar(){
    const bar = document.getElementById("summaryBar");
    bar.innerHTML = "";

    const org = state.meta.orgLevel;
    const school = (org === "School") ? state.meta.school : "District";
    const focus = FOCUS_META[state.meta.weeklyFocus]?.title || state.meta.weeklyFocus;

    bar.appendChild(chip(`${org} submission`, "gray"));
    bar.appendChild(chip(`${school}`, "gray"));
    bar.appendChild(chip(`${focus}`, "gray"));

    const score = statusToScore(state.status.status);
    const sLabel = (state.status.status || "").toUpperCase();
    bar.appendChild(chip(`Lane status: ${sLabel} (score ${score})`, state.status.status));
  }

  function chip(text, status){
    const d = document.createElement("div");
    d.className = "chip";
    const dot = document.createElement("span");
    dot.className = "statusDot " + statusClass(status);
    dot.style.width = "9px";
    dot.style.height = "9px";
    dot.style.boxShadow = "none";
    d.appendChild(dot);
    const t = document.createElement("span");
    t.textContent = text;
    d.appendChild(t);
    return d;
  }

  // =========================
  // ARTIFACT UPLOAD
  // =========================
  function readFileAsBase64(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const result = String(reader.result || "");
        const parts = result.split(",");
        if(parts.length < 2) return reject(new Error("Invalid file encoding."));
        resolve(parts[1]);
      };
      reader.onerror = () => reject(reader.error || new Error("File read failed."));
      reader.readAsDataURL(file);
    });
  }

  async function uploadArtifactToDrive(file){
    const b64 = await readFileAsBase64(file);

    const payload = {
      action: "upload",
      file_name: file.name,
      mime_type: file.type || "application/octet-stream",
      base64: b64,
      week_of: state.meta.weekOf,
      org_level: state.meta.orgLevel,
      school: state.meta.orgLevel === "School" ? state.meta.school : "District",
      focus_area_id: state.meta.weeklyFocus
    };

    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if(!data.ok) throw new Error(data.error || "Upload failed.");
    return data.file;
  }

  // =========================
  // SHEET SUBMISSION
  // =========================
  function buildSubmissionPayload(){
    const focusId = state.meta.weeklyFocus;
    const focusTitle = FOCUS_META[focusId]?.title || focusId;

    const core_answers = {};
    CORE_FRAMING_QUESTIONS.forEach(q => core_answers[q.id] = ensureRoleAnswer("core", q.id));

    const focus_answers = {};
    (FOCUS_QUESTIONS[focusId] || []).forEach(q => focus_answers[q.id] = ensureRoleAnswer("focus", q.id));

    const closing_answers = { closing: ensureRoleAnswer("closing", "closing") };

    return {
      week_of: state.meta.weekOf,
      view_mode: state.meta.viewMode,

      org_level: state.meta.orgLevel,
      school: state.meta.orgLevel === "School" ? state.meta.school : "District",
      submitter_name: state.meta.submitterName,
      submitter_role: state.meta.submitterRole,

      weekly_focus_area_id: focusId,
      weekly_focus_area_title: focusTitle,

      status: state.status.status,
      metric1: state.status.metric1,
      metric2: state.status.metric2,
      metric3: state.status.metric3,
      lane_owner: state.status.laneOwner,

      core_answers,
      focus_answers,
      closing_answers
    };
  }

  async function submitToSheet(){
    const payload = buildSubmissionPayload();

    const btn = document.getElementById("submitToSheetBtn");
    btn.disabled = true;
    btn.textContent = "Submitting...";

    try{
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || "Submit failed.");
      alert("Submitted to Google Sheet.");
      // After submit, refresh trends so charts are up-to-date
      await refreshTrends(true);
    }catch(err){
      alert("Submit failed: " + String(err));
    }finally{
      btn.disabled = false;
      btn.textContent = "Submit to Google Sheet";
    }
  }

  // =========================
  // TRENDS + EVIDENCE MODAL
  // =========================
  let SUBMISSION_CACHE = [];

  function setSubmissionCache(rows){
    SUBMISSION_CACHE = Array.isArray(rows) ? rows : [];
  }

  async function fetchAllRows(){
    const res = await fetch(SCRIPT_URL, { method: "GET" });
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || "Failed to load rows");
    return data.rows || [];
  }

  function parseDateMaybe(d){
    const dt = new Date(d);
    return isNaN(dt.getTime()) ? null : dt;
  }

  function startOfMonth(dt){ return new Date(dt.getFullYear(), dt.getMonth(), 1); }
  function startOfYear(dt){ return new Date(dt.getFullYear(), 0, 1); }

  function applyTrendFilters(rows){
    const orgLevel = document.getElementById("trendOrgLevel").value;
    const fromStr = document.getElementById("dateFrom").value;
    const toStr = document.getElementById("dateTo").value;

    const from = fromStr ? new Date(fromStr + "T00:00:00") : null;
    const to = toStr ? new Date(toStr + "T23:59:59") : null;

    const focusId = state.meta.weeklyFocus;

    return rows.filter(r => {
      if(orgLevel !== "all" && r.org_level !== orgLevel) return false;
      if(r.weekly_focus_area_id && r.weekly_focus_area_id !== focusId) return false;

      const ts = parseDateMaybe(r.timestamp_iso) || parseDateMaybe(r.week_of);
      if(!ts) return false;
      if(from && ts < from) return false;
      if(to && ts > to) return false;

      return true;
    });
  }

  function avgScore(rows){
    if(!rows.length) return 0;
    const sum = rows.reduce((a, r) => a + (Number(r.status_score) || 0), 0);
    return sum / rows.length;
  }

  function scoreLabel(avg){
    if(avg >= 2.5) return "Green";
    if(avg >= 1.75) return "Yellow";
    if(avg > 0) return "Red";
    return "No data";
  }

  function computeRollups(rows){
    const now = new Date();
    const monthStart = startOfMonth(now);
    const yearStart = startOfYear(now);

    const weekOf = state.meta.weekOf ? new Date(state.meta.weekOf + "T00:00:00") : null;
    let weeklyRows = [];
    if(weekOf){
      weeklyRows = rows.filter(r => String(r.week_of).slice(0,10) === String(state.meta.weekOf).slice(0,10));
    } else {
      const sevenDaysAgo = new Date(now.getTime() - 7*24*60*60*1000);
      weeklyRows = rows.filter(r => {
        const ts = parseDateMaybe(r.timestamp_iso);
        return ts && ts >= sevenDaysAgo;
      });
    }

    const monthlyRows = rows.filter(r => {
      const ts = parseDateMaybe(r.timestamp_iso);
      return ts && ts >= monthStart;
    });

    const ytdRows = rows.filter(r => {
      const ts = parseDateMaybe(r.timestamp_iso);
      return ts && ts >= yearStart;
    });

    return {
      weekly: avgScore(weeklyRows),
      monthly: avgScore(monthlyRows),
      ytd: avgScore(ytdRows)
    };
  }

  function renderRollups(rollups){
    document.getElementById("rollupWeekly").textContent =
      rollups.weekly ? `${rollups.weekly.toFixed(2)} (${scoreLabel(rollups.weekly)})` : "No data";
    document.getElementById("rollupMonthly").textContent =
      rollups.monthly ? `${rollups.monthly.toFixed(2)} (${scoreLabel(rollups.monthly)})` : "No data";
    document.getElementById("rollupYtd").textContent =
      rollups.ytd ? `${rollups.ytd.toFixed(2)} (${scoreLabel(rollups.ytd)})` : "No data";
  }

  function renderTrendsTable(rows){
    const tbody = document.getElementById("trendsTableBody");
    tbody.innerHTML = "";

    setSubmissionCache(rows);

    const sorted = [...rows].sort((a,b) => String(b.timestamp_iso).localeCompare(String(a.timestamp_iso)));
    sorted.slice(0, 250).forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${escapeHtml(String(r.timestamp_iso || "").replace("T"," ").slice(0,16))}</td>
        <td>${escapeHtml(r.org_level || "")}</td>
        <td>${escapeHtml(r.school || "")}</td>
        <td>${escapeHtml(r.weekly_focus_area_title || r.weekly_focus_area_id || "")}</td>
        <td>${escapeHtml(String(r.status || "").toUpperCase())}</td>
        <td>${escapeHtml(r.metric1 || "")}</td>
        <td>${escapeHtml(r.metric2 || "")}</td>
        <td>${escapeHtml(r.metric3 || "")}</td>
        <td><button class="miniBtn primary" style="padding:8px 10px;">View Evidence</button></td>
      `;

      const btn = tr.querySelector("button");
      btn.addEventListener("click", () => {
        openEvidenceModal({
          week_of: r.week_of,
          school: r.school,
          weekly_focus_area_id: r.weekly_focus_area_id,
          weekly_focus_area_title: r.weekly_focus_area_title,
          org_level: r.org_level,
          status: r.status
        });
      });

      tbody.appendChild(tr);
    });
  }

  async function refreshTrends(silent=false){
    try{
      const all = await fetchAllRows();
      const filtered = applyTrendFilters(all);
      const rollups = computeRollups(filtered);
      renderRollups(rollups);
      renderTrendsTable(filtered);

      requestAnalyticsUpdate("trends");

      if(!silent) alert("Trends refreshed.");
    }catch(err){
      if(!silent) alert("Trend refresh failed: " + String(err));
    }
  }

  // Evidence modal helpers (unchanged, but will read rating fields if present in JSON)
  function safeJsonParse(maybeJson){
    if(!maybeJson) return null;
    if(typeof maybeJson === "object") return maybeJson;
    try{ return JSON.parse(maybeJson); }catch(e){ return null; }
  }

  function extractUrlsFromText(text){
    const t = String(text || "");
    const urls = t.match(/https?:\/\/[^\s)"]+/g) || [];
    return Array.from(new Set(urls));
  }

  function extractArtifactLinksFromRoleAnswer(ans){
    const links = [];
    if(!ans) return links;

    if(Array.isArray(ans.artifacts)){
      ans.artifacts.forEach(a => {
        if(a && a.url) links.push({ url: a.url, label: a.label || a.name || "Artifact", kind: a.kind || "artifact" });
      });
    }

    extractUrlsFromText(ans.text).forEach(u => links.push({ url: u, label: "Link in answer", kind: "inline" }));
    extractUrlsFromText(ans.notes).forEach(u => links.push({ url: u, label: "Link in note", kind: "inline" }));

    return links;
  }

  function extractArtifactLinksFromAnswerObj(ans){
    const links = [];
    if(!ans) return links;

    const normalized = migrateOldAnswerShape(ans);
    if(normalized && normalized.school && normalized.district){
      links.push(...extractArtifactLinksFromRoleAnswer(normalized.school));
      links.push(...extractArtifactLinksFromRoleAnswer(normalized.district));
      return links;
    }

    links.push(...extractArtifactLinksFromRoleAnswer(ans));
    return links;
  }

  function extractEvidenceLinksFromRow(row){
    const all = [];

    const core = safeJsonParse(row.core_answers_json);
    const focus = safeJsonParse(row.focus_answers_json);
    const closing = safeJsonParse(row.closing_answers_json);

    if(core && typeof core === "object"){
      Object.values(core).forEach(ans => all.push(...extractArtifactLinksFromAnswerObj(ans)));
    }
    if(focus && typeof focus === "object"){
      Object.values(focus).forEach(ans => all.push(...extractArtifactLinksFromAnswerObj(ans)));
    }
    if(closing && typeof closing === "object"){
      Object.values(closing).forEach(ans => all.push(...extractArtifactLinksFromAnswerObj(ans)));
    }

    extractUrlsFromText(row.evidence_blob).forEach(u => all.push({ url: u, label: "Evidence link", kind: "blob" }));

    const seen = new Set();
    return all.filter(x => {
      if(!x.url) return false;
      if(seen.has(x.url)) return false;
      seen.add(x.url);
      return true;
    });
  }

  function openEvidenceModal(context){
    const week = String(context.week_of || "").trim();
    const school = String(context.school || "").trim();
    const focusId = String(context.weekly_focus_area_id || "").trim();
    const focusTitle = String(context.weekly_focus_area_title || "").trim();
    const orgLevel = String(context.org_level || "").trim();

    const modal = document.getElementById("evidenceModal");
    const titleEl = document.getElementById("evidenceTitle");
    const subEl = document.getElementById("evidenceSubtitle");
    const summaryEl = document.getElementById("evidenceSummary");
    const listEl = document.getElementById("evidenceList");

    titleEl.textContent = "Evidence";
    subEl.textContent = `${orgLevel || "Org"} | ${school || "School"} | ${focusTitle || focusId || "Focus"} | ${week || "Week"}`;

    const matchedRows = SUBMISSION_CACHE.filter(r => {
      if(week && String(r.week_of || "").slice(0,10) !== week.slice(0,10)) return false;
      if(focusId && String(r.weekly_focus_area_id || "") !== focusId) return false;

      const rOrg = String(r.org_level || "");
      const rSchool = String(r.school || "");

      if(rOrg === "District") return true;
      return rSchool === school;
    });

    let links = [];
    matchedRows.forEach(r => { links = links.concat(extractEvidenceLinksFromRow(r)); });

    summaryEl.innerHTML = "";
    const pills = [
      { label: "Rows matched", value: matchedRows.length },
      { label: "Artifacts found", value: links.length },
      { label: "Status", value: String(context.status || "").toUpperCase() || "N/A" }
    ];
    pills.forEach(p => {
      const div = document.createElement("div");
      div.className = "pillMini";
      div.textContent = `${p.label}: ${p.value}`;
      summaryEl.appendChild(div);
    });

    listEl.innerHTML = "";
    if(!links.length){
      const empty = document.createElement("div");
      empty.className = "evidence-item";
      empty.innerHTML = `
        <div class="meta">
          <div class="title">No artifacts found for this week and focus yet</div>
          <div class="hint">Upload or add a link inside any School or District box, then submit again.</div>
        </div>
      `;
      listEl.appendChild(empty);
    }else{
      links.forEach((l, idx) => {
        const item = document.createElement("div");
        item.className = "evidence-item";
        const isDrive = String(l.url).includes("drive.google.com");
        const label = l.label || (isDrive ? `Drive Artifact ${idx+1}` : `Evidence Link ${idx+1}`);
        item.innerHTML = `
          <div class="meta">
            <div class="title">${escapeHtml(label)}</div>
            <div class="hint">${escapeHtml(l.kind || "")}${isDrive ? " | Google Drive" : ""}</div>
          </div>
          <a class="btn secondary" href="${escapeHtml(l.url)}" target="_blank" rel="noopener">Open</a>
        `;
        listEl.appendChild(item);
      });
    }

    modal.classList.remove("hidden");
    modal.setAttribute("aria-hidden", "false");
    document.addEventListener("keydown", escCloseEvidenceOnce);
  }

  function escCloseEvidenceOnce(e){
    if(e.key === "Escape") closeEvidenceModal();
  }

  function closeEvidenceModal(){
    const modal = document.getElementById("evidenceModal");
    modal.classList.add("hidden");
    modal.setAttribute("aria-hidden", "true");
    document.removeEventListener("keydown", escCloseEvidenceOnce);
  }

  // =========================
  // ANALYTICS (Animated Charts)
  // =========================
  const analytics = {
    lastSource: "init",
    bar: { current: { school:0, district:0 }, ytd: { school:0, district:0 } },
    pie: { green:0, yellow:0, red:0 }
  };

  let chartAnim = { barT:0, pieT:0, raf:null };

  function requestAnalyticsUpdate(source){
    analytics.lastSource = source || "unknown";
    computeAnalytics();
    animateCharts();
  }

  function computeAnalytics(){
    // 1) Status bar chart: Current week + YTD averages for selected school and district
    const focusId = state.meta.weeklyFocus;
    const week = String(state.meta.weekOf || "").slice(0,10);
    const selectedSchool = state.meta.school;

    const rows = SUBMISSION_CACHE || [];

    const districtRows = rows.filter(r =>
      String(r.weekly_focus_area_id || "") === focusId && String(r.org_level || "") === "District"
    );

    const schoolRows = rows.filter(r =>
      String(r.weekly_focus_area_id || "") === focusId && String(r.org_level || "") === "School" && String(r.school || "") === selectedSchool
    );

    const now = new Date();
    const yearStart = new Date(now.getFullYear(), 0, 1);

    const filterYTD = (r) => {
      const ts = parseDateMaybe(r.timestamp_iso) || parseDateMaybe(r.week_of);
      return ts && ts >= yearStart;
    };
    const filterWeek = (r) => String(r.week_of || "").slice(0,10) === week;

    const schoolWeekAvg = avgScore(schoolRows.filter(filterWeek));
    const districtWeekAvg = avgScore(districtRows.filter(filterWeek));
    const schoolYtdAvg = avgScore(schoolRows.filter(filterYTD));
    const districtYtdAvg = avgScore(districtRows.filter(filterYTD));

    analytics.bar.current.school = schoolWeekAvg || 0;
    analytics.bar.current.district = districtWeekAvg || 0;
    analytics.bar.ytd.school = schoolYtdAvg || 0;
    analytics.bar.ytd.district = districtYtdAvg || 0;

    // 2) Pie: Core question ratings (School + District) from LOCAL state (current form)
    const counts = { green:0, yellow:0, red:0 };
    CORE_FRAMING_QUESTIONS.forEach(q => {
      const s = getRoleAnswer("core", q.id, "school").rating;
      const d = getRoleAnswer("core", q.id, "district").rating;
      if(s === "green" || s === "yellow" || s === "red") counts[s] += 1;
      if(d === "green" || d === "yellow" || d === "red") counts[d] += 1;
    });

    analytics.pie = counts;

    // Pill
    const pill = document.getElementById("analyticsPill");
    const hasAny = (analytics.bar.current.school || analytics.bar.current.district || analytics.bar.ytd.school || analytics.bar.ytd.district || counts.green || counts.yellow || counts.red);
    pill.textContent = hasAny ? "Live" : "No data";
  }

  function animateCharts(){
    chartAnim.barT = 0;
    chartAnim.pieT = 0;
    if(chartAnim.raf) cancelAnimationFrame(chartAnim.raf);

    const start = performance.now();
    const dur = 520; // tight, snappy

    const step = (t) => {
      const p = Math.min(1, (t - start) / dur);
      const eased = 1 - Math.pow(1 - p, 3); // easeOutCubic

      drawBarChart(document.getElementById("barStatus"), eased);
      drawPieChart(document.getElementById("pieCore"), eased);

      if(p < 1){
        chartAnim.raf = requestAnimationFrame(step);
      }
    };
    chartAnim.raf = requestAnimationFrame(step);
  }

  function ensureHiDpiCanvas(canvas){
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    const w = Math.max(10, Math.floor(rect.width * dpr));
    const h = Math.max(10, Math.floor(rect.height * dpr));
    if(canvas.width !== w || canvas.height !== h){
      canvas.width = w;
      canvas.height = h;
    }
    const ctx = canvas.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
    return ctx;
  }

  function drawBarChart(canvas, t){
    if(!canvas) return;
    const ctx = ensureHiDpiCanvas(canvas);
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;

    ctx.clearRect(0,0,w,h);

    // frame
    roundRect(ctx, 0.5, 0.5, w-1, h-1, 12);
    ctx.fillStyle = "rgba(245,245,247,0.55)";
    ctx.fill();
    ctx.strokeStyle = "rgba(0,0,0,0.10)";
    ctx.stroke();

    // bars: 4 bars (School week, District week, School YTD, District YTD), scale 0..3
    const vals = [
      { label:"School", sub:"Week", v: analytics.bar.current.school },
      { label:"District", sub:"Week", v: analytics.bar.current.district },
      { label:"School", sub:"YTD", v: analytics.bar.ytd.school },
      { label:"District", sub:"YTD", v: analytics.bar.ytd.district }
    ];

    const pad = 12;
    const innerW = w - pad*2;
    const innerH = h - pad*2;
    const baseY = pad + innerH - 18; // leave space for labels

    const barW = innerW / vals.length * 0.64;
    const gap = innerW / vals.length * 0.36;
    const maxV = 3;

    // axis line
    ctx.strokeStyle = "rgba(0,0,0,0.10)";
    ctx.beginPath();
    ctx.moveTo(pad, baseY);
    ctx.lineTo(w - pad, baseY);
    ctx.stroke();

    vals.forEach((b, i) => {
      const xCenter = pad + (i + 0.5) * (innerW / vals.length);
      const x = xCenter - barW/2;
      const barMaxH = innerH - 28;
      const barH = (Math.max(0, Math.min(maxV, b.v)) / maxV) * barMaxH * t;

      // color by value
      const cls = (b.v >= 2.5) ? "green" : (b.v >= 1.75 ? "yellow" : (b.v > 0 ? "red" : "gray"));
      const fill = cls === "green" ? "rgba(22,163,74,0.55)"
                : cls === "yellow" ? "rgba(245,158,11,0.60)"
                : cls === "red" ? "rgba(220,38,38,0.55)"
                : "rgba(107,114,128,0.35)";
      const stroke = cls === "green" ? "rgba(22,163,74,0.85)"
                  : cls === "yellow" ? "rgba(245,158,11,0.90)"
                  : cls === "red" ? "rgba(220,38,38,0.85)"
                  : "rgba(107,114,128,0.55)";

      roundRect(ctx, x, baseY - barH, barW, barH, 10);
      ctx.fillStyle = fill;
      ctx.fill();
      ctx.strokeStyle = stroke;
      ctx.lineWidth = 1;
      ctx.stroke();

      // value
      ctx.fillStyle = "rgba(17,17,17,0.85)";
      ctx.font = "900 11px Inter, system-ui, Arial";
      const vText = (b.v ? b.v.toFixed(2) : "0.00");
      ctx.fillText(vText, x + 6, baseY - barH - 6);

      // labels
      ctx.fillStyle = "rgba(107,114,128,1)";
      ctx.font = "900 10px Inter, system-ui, Arial";
      ctx.fillText(b.label, x + 2, h - 16);
      ctx.font = "800 9px Inter, system-ui, Arial";
      ctx.fillText(b.sub, x + 2, h - 6);
    });
  }

  function drawPieChart(canvas, t){
    if(!canvas) return;
    const ctx = ensureHiDpiCanvas(canvas);
    const w = canvas.getBoundingClientRect().width;
    const h = canvas.getBoundingClientRect().height;

    ctx.clearRect(0,0,w,h);

    // frame
    roundRect(ctx, 0.5, 0.5, w-1, h-1, 12);
    ctx.fillStyle = "rgba(245,245,247,0.55)";
    ctx.fill();
    ctx.strokeStyle = "rgba(0,0,0,0.10)";
    ctx.stroke();

    const counts = analytics.pie || {green:0,yellow:0,red:0};
    const total = (counts.green || 0) + (counts.yellow || 0) + (counts.red || 0);

    const cx = w * 0.33;
    const cy = h * 0.52;
    const r = Math.min(w, h) * 0.30;

    // if no data, draw ring + text
    if(!total){
      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, Math.PI*2);
      ctx.strokeStyle = "rgba(107,114,128,0.35)";
      ctx.lineWidth = 10;
      ctx.stroke();

      ctx.fillStyle = "rgba(107,114,128,1)";
      ctx.font = "900 11px Inter, system-ui, Arial";
      ctx.fillText("No ratings yet", w*0.55, h*0.52);
      ctx.font = "800 10px Inter, system-ui, Arial";
      ctx.fillText("Rate core questions", w*0.55, h*0.52 + 14);
      return;
    }

    const slices = [
      { key:"green", val: counts.green, color:"rgba(22,163,74,0.65)", stroke:"rgba(22,163,74,0.95)" },
      { key:"yellow", val: counts.yellow, color:"rgba(245,158,11,0.70)", stroke:"rgba(245,158,11,0.98)" },
      { key:"red", val: counts.red, color:"rgba(220,38,38,0.65)", stroke:"rgba(220,38,38,0.95)" }
    ];

    let start = -Math.PI/2;
    const endCap = start + (Math.PI*2 * t);

    slices.forEach(s => {
      if(!s.val) return;
      const frac = s.val / total;
      const ang = Math.PI*2 * frac;

      const sliceStart = start;
      const sliceEnd = start + ang;

      // animate by clipping the visible arc to endCap
      const visEnd = Math.min(sliceEnd, endCap);
      if(visEnd <= sliceStart){
        start += ang;
        return;
      }

      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, r, sliceStart, visEnd);
      ctx.closePath();
      ctx.fillStyle = s.color;
      ctx.fill();
      ctx.strokeStyle = s.stroke;
      ctx.lineWidth = 1;
      ctx.stroke();

      start += ang;
    });

    // donut hole
    ctx.beginPath();
    ctx.arc(cx, cy, r*0.58, 0, Math.PI*2);
    ctx.fillStyle = "rgba(255,255,255,0.95)";
    ctx.fill();

    // center label
    ctx.fillStyle = "rgba(17,17,17,0.90)";
    ctx.font = "900 12px Inter, system-ui, Arial";
    ctx.fillText(String(total), cx - 6, cy + 4);
    ctx.fillStyle = "rgba(107,114,128,1)";
    ctx.font = "900 10px Inter, system-ui, Arial";
    ctx.fillText("ratings", cx - 18, cy + 18);

    // legend on right
    const lx = w * 0.58;
    const ly = h * 0.28;
    const items = [
      { name:"Green", val: counts.green, dot:"rgba(22,163,74,0.95)" },
      { name:"Yellow", val: counts.yellow, dot:"rgba(245,158,11,0.98)" },
      { name:"Red", val: counts.red, dot:"rgba(220,38,38,0.95)" }
    ];
    ctx.font = "900 11px Inter, system-ui, Arial";
    items.forEach((it, idx) => {
      const y = ly + idx*22;
      ctx.fillStyle = it.dot;
      ctx.beginPath();
      ctx.arc(lx, y, 5, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = "rgba(17,17,17,0.90)";
      ctx.fillText(`${it.name}: ${it.val || 0}`, lx + 12, y + 4);
    });
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  // =========================
  // PAGE RENDER
  // =========================
  function renderPage(){
    document.getElementById("weekOf").value = state.meta.weekOf;
    document.getElementById("viewMode").value = state.meta.viewMode;
    document.getElementById("orgLevel").value = state.meta.orgLevel;
    document.getElementById("schoolSelect").value = state.meta.school;
    document.getElementById("submitterRole").value = state.meta.submitterRole;
    document.getElementById("submitterName").value = state.meta.submitterName;
    document.getElementById("weeklyFocus").value = state.meta.weeklyFocus;

    setSchoolVisibility();

    document.getElementById("statusSelect").value = state.status.status;
    document.getElementById("metric1").value = state.status.metric1;
    document.getElementById("metric2").value = state.status.metric2;
    document.getElementById("metric3").value = state.status.metric3;
    document.getElementById("laneOwner").value = state.status.laneOwner;

    updateStatusDot();

    const focusId = state.meta.weeklyFocus;
    const meta = FOCUS_META[focusId];
    document.getElementById("pageTitle").textContent = `Weekly Focus: ${meta ? meta.title : "Focus Area"}`;
    document.getElementById("pageContext").textContent =
      "Each question includes School and District sections. Core questions now include RYG ratings (School and District) to make signal strength visible, not assumed.";

    document.getElementById("focusTitle").textContent = `Focus Area Questions: ${meta ? meta.title : ""}`;
    document.getElementById("focusHint").textContent = meta ? meta.hint : "";

    // Core questions: WITH ratings (red/yellow/green)
    renderQuestionList("coreQuestions", "core", CORE_FRAMING_QUESTIONS, true);

    // Focus questions: no ratings by default (keep clean). If you want ratings here too, flip this to true.
    renderQuestionList("focusQuestions", "focus", FOCUS_QUESTIONS[focusId] || [], false);

    // Closing: no ratings
    renderQuestionList("closingQuestion", "closing", [CLOSING_QUESTION], false);

    renderSummaryBar();

    // Auto-expand district panels for district contributors
    if(isDistrictContributor()){
      document.querySelectorAll(".districtBody").forEach(body => body.classList.remove("collapsed"));
      document.querySelectorAll('[data-action="toggleDistrict"]').forEach(btn => btn.textContent = "Hide District");
      CORE_FRAMING_QUESTIONS.forEach(q => setDistrictExpanded("core", q.id, true));
      (FOCUS_QUESTIONS[focusId] || []).forEach(q => setDistrictExpanded("focus", q.id, true));
      setDistrictExpanded("closing", "closing", true);
    }else{
      // collapse district panels by default for school users
      if(AUTO_COLLAPSE_DISTRICT_FOR_SCHOOL){
        // keep any user-opened panels as-is
      }
    }

    // analytics update
    requestAnalyticsUpdate("render");
  }

  // =========================
  // WIRES
  // =========================
  function wireMeta(){
    const bind = (id, fn, evt="change") => document.getElementById(id).addEventListener(evt, fn);

    bind("weekOf", () => { state.meta.weekOf = document.getElementById("weekOf").value; saveState(); });
    bind("viewMode", () => { state.meta.viewMode = document.getElementById("viewMode").value; saveState(); });

    bind("orgLevel", () => {
      state.meta.orgLevel = document.getElementById("orgLevel").value;
      setSchoolVisibility();
      saveState();
      renderPage();
    });

    bind("schoolSelect", () => { state.meta.school = document.getElementById("schoolSelect").value; saveState(); renderSummaryBar(); });
    bind("submitterRole", () => { state.meta.submitterRole = document.getElementById("submitterRole").value; saveState(); });

    document.getElementById("submitterName").addEventListener("input", () => {
      state.meta.submitterName = document.getElementById("submitterName").value;
      saveState();
    });

    bind("weeklyFocus", () => {
      state.meta.weeklyFocus = document.getElementById("weeklyFocus").value;
      saveState();
      renderPage();
    });

    bind("statusSelect", () => {
      state.status.status = document.getElementById("statusSelect").value;
      saveState();
      updateStatusDot();
      renderSummaryBar();
    });

    ["metric1","metric2","metric3","laneOwner"].forEach(id => {
      document.getElementById(id).addEventListener("input", () => {
        state.status[id === "laneOwner" ? "laneOwner" : id] = document.getElementById(id).value;
        saveState();
      });
    });

    // When trends filters change, keep charts responsive (but don't fetch automatically)
    ["trendOrgLevel","dateFrom","dateTo"].forEach(id => {
      document.getElementById(id).addEventListener("change", () => requestAnalyticsUpdate("filters"));
    });

    window.addEventListener("resize", () => requestAnalyticsUpdate("resize"));
  }

  function wireButtons(){
    document.getElementById("saveLocalBtn").addEventListener("click", () => {
      saveState();
      alert("Saved locally.");
    });

    document.getElementById("printBtn").addEventListener("click", () => {
      saveState();
      window.print();
    });

    document.getElementById("exportBtn").addEventListener("click", () => {
      saveState();
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `FCS_Weekly_Executive_Review_${state.meta.weekOf || "week"}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    document.getElementById("importFile").addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      e.target.value = "";
      if(!file) return;
      try{
        const text = await file.text();
        const parsed = JSON.parse(text);
        state = { ...defaultState(), ...parsed };
        districtExpandMap = state._districtExpandMap || {};
        saveState();
        renderPage();
        alert("Imported.");
      }catch(err){
        alert("Import failed: " + String(err));
      }
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      if(!confirm("Reset everything to defaults for this device?")) return;
      state = defaultState();
      districtExpandMap = {};
      saveState();
      renderPage();
    });

    document.getElementById("submitToSheetBtn").addEventListener("click", submitToSheet);
    document.getElementById("refreshTrendsBtn").addEventListener("click", () => refreshTrends(false));
  }

  // =========================
  // INIT
  // =========================
  wireMeta();
  wireButtons();
  renderPage();

  // Optional: auto-load trends once per session so analytics aren't empty.
  // If you do NOT want this, delete the next line.
  refreshTrends(true);
</script>
</body>
</html>

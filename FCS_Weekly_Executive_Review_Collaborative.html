<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FCS Weekly Executive Review</title>

  <!-- Charts (animated) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --black:#111111;
      --gray:#6b7280;
      --white:#ffffff;
      --gold:#dbd59b;
      --bg:#f5f5f7;
      --shadow:0 14px 36px rgba(0,0,0,0.14);
      --shadow-soft:0 10px 22px rgba(0,0,0,0.10);
      --radius:22px;
      --radius-sm:16px;
      --border:1px solid rgba(0,0,0,0.12);

      --green:#16a34a;
      --yellow:#f59e0b;
      --red:#dc2626;
      --blue:#2563eb;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--black);
    }

    .app{
      display:grid;
      grid-template-columns: 360px 1fr;
      min-height:100vh;
    }

    /* LEFT SIDEBAR */
    .sidebar{
      background: var(--white);
      border-right: var(--border);
      padding:18px 16px;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow:auto;
    }

    .brandLogoWrap{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:12px 10px 10px 10px;
      border-radius: 18px;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.10);
      box-shadow: 0 12px 26px rgba(0,0,0,0.12);
      margin-bottom:12px;
    }
    .brandLogo{
      width: 210px;
      max-width: 100%;
      height: auto;
      display:block;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,0.16));
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
      padding:12px 12px 14px 12px;
      border-radius: var(--radius-sm);
      border: var(--border);
      background: linear-gradient(180deg, rgba(219,213,155,0.28), rgba(255,255,255,1));
      box-shadow: var(--shadow-soft);
      margin-bottom:14px;
    }
    .brand h1{ margin:0; font-size:16px; letter-spacing:0.2px; }
    .brand .sub{ font-size:12px; color: var(--gray); line-height:1.35; }

    label{ font-size:11px; color: var(--gray); }
    input[type="text"], input[type="date"], select, textarea{
      width:100%;
      border: var(--border);
      border-radius: 12px;
      padding:10px 10px;
      background: #fff;
      font-size:13px;
      outline:none;
    }
    textarea{ min-height: 92px; resize: vertical; }

    .meta{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin:12px 0 12px 0;
    }
    .meta .field{ display:flex; flex-direction:column; gap:6px; }
    .meta .span2{ grid-column: 1 / span 2; }

    .tools{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
    }
    .btn{
      border:none;
      border-radius: 14px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
      background: var(--black);
      color: var(--white);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .btn:hover{ transform: translateY(-2px); box-shadow: var(--shadow-soft); }
    .btn.secondary{
      background:#fff; color: var(--black);
      border: var(--border);
    }
    .btn.gold{ background: var(--gold); color: var(--black); }
    .btn.danger{ background: var(--red); color:#fff; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; box-shadow:none; }

    .footerNote{
      margin-top:12px;
      color: var(--gray);
      font-size:11px;
      line-height:1.35;
    }

    /* MAIN CONTENT */
    .content{
      padding:22px 22px 44px 22px;
      overflow:auto;
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      margin-bottom:14px;
    }
    .topbar h2{ margin:0; font-size:18px; letter-spacing:0.2px; }
    .topbar .context{
      margin-top:4px;
      color: var(--gray);
      font-size:12px;
      line-height:1.35;
      max-width: 900px;
    }

    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; }

    .card{
      background: #fff;
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-soft);
      padding:16px;
    }

    .cardHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:10px;
    }
    .card h3{ margin:0; font-size:14px; letter-spacing:0.2px; }
    .muted{ color: var(--gray); font-size:12px; line-height:1.35; }

    .pill{
      font-size:11px;
      padding:5px 10px;
      border-radius:999px;
      border: var(--border);
      background:#fff;
      white-space:nowrap;
    }

    /* COLLAPSIBLE ANALYTICS (SIDEBAR) */
    details.analytics{
      border: var(--border);
      border-radius: 18px;
      background:#fff;
      box-shadow: var(--shadow-soft);
      overflow:hidden;
      margin-top:12px;
    }
    details.analytics summary{
      list-style:none;
      cursor:pointer;
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    details.analytics summary::-webkit-details-marker{ display:none; }

    .analyticsTitle{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .analyticsTitle .t{ font-weight:900; font-size:12px; letter-spacing:0.2px; }
    .analyticsTitle .d{ color:var(--gray); font-size:11px; line-height:1.25; }
    .chev{
      width:28px; height:28px;
      border-radius: 10px;
      border: var(--border);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      background:#fff;
      transition: transform .12s ease;
      font-size:12px;
    }
    details.analytics[open] .chev{ transform: rotate(180deg); }

    .analyticsBody{
      padding: 0 12px 12px 12px;
    }
    .chartsGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 6px;
    }
    .chartCard{
      border: var(--border);
      border-radius: 16px;
      padding: 10px;
      background: rgba(245,245,247,.55);
    }
    .chartCard .label{
      font-weight:900;
      font-size:11px;
      margin-bottom:4px;
    }
    .chartCard .hint{
      color: var(--gray);
      font-size:10px;
      margin-bottom:6px;
      line-height:1.25;
    }
    /* tighter charts in sidebar */
    canvas{ width:100% !important; height:160px !important; }

    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      canvas{ height:190px !important; }
    }

    /* STATUS DOTS */
    .statusDot{
      width:10px; height:10px; border-radius:99px;
      background: rgba(107,114,128,.5);
      box-shadow: 0 0 0 3px rgba(107,114,128,.12);
      flex:0 0 auto;
      display:inline-block;
      vertical-align:middle;
      margin-right:8px;
    }
    .statusDot.green{ background: var(--green); box-shadow: 0 0 0 3px rgba(22,163,74,.14); }
    .statusDot.yellow{ background: var(--yellow); box-shadow: 0 0 0 3px rgba(245,158,11,.16); }
    .statusDot.red{ background: var(--red); box-shadow: 0 0 0 3px rgba(220,38,38,.14); }

    /* QUESTIONS */
    .qList{ display:flex; flex-direction:column; gap:10px; }
    .qItem{
      border: var(--border);
      border-radius: 16px;
      padding:12px;
      background: rgba(245,245,247,.6);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .qItem:hover{
      transform: translateY(-2px);
      box-shadow: var(--shadow-soft);
      background: rgba(219,213,155,.18);
    }
    .qTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .qPrompt{
      font-size:13px;
      font-weight:800;
      line-height:1.35;
    }
    .tip{
      font-size:11px;
      color: var(--gray);
      margin-top:6px;
      display:none;
    }
    .qItem:hover .tip{ display:block; }

    /* Core per-question RYG selector */
    .qItem select[data-action="qStatus"]{
      border-radius: 12px;
      padding:8px 10px;
      border: var(--border);
      background:#fff;
      font-weight:900;
      font-size:12px;
      width:auto;
      min-width: 110px;
    }

    .qAnswer{ width:100%; min-height: 110px; }

    .inline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .laneRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 980px){
      .laneRow{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brandLogoWrap">
        <img class="brandLogo" src="https://i.postimg.cc/JhPCnwDT/Compass_Logo.png" alt="Compass Logo">
      </div>

      <div class="brand">
        <h1>FCS Weekly Executive Review</h1>
        <div class="sub">Same questions. Better answers. Evidence first.</div>
      </div>

      <div class="meta">
        <div class="field">
          <label for="weekOf">Week of</label>
          <input id="weekOf" type="date"/>
        </div>
        <div class="field">
          <label for="viewMode">View</label>
          <select id="viewMode">
            <option value="prep">Prep (Tue-Fri)</option>
            <option value="monday">Monday Review</option>
          </select>
        </div>

        <div class="field">
          <label for="orgLevel">Contributor</label>
          <select id="orgLevel">
            <option value="School">School</option>
            <option value="District">District</option>
          </select>
        </div>

        <div class="field" id="schoolField">
          <label for="schoolSelect">School</label>
          <select id="schoolSelect">
            <option value="Ewing ES">Ewing ES</option>
            <option value="Flemingsburg ES">Flemingsburg ES</option>
            <option value="Hillsboro ES">Hillsboro ES</option>
            <option value="Simons ES">Simons ES</option>
            <option value="Fleming Co. HS">Fleming Co. HS</option>
          </select>
        </div>

        <div class="field" style="grid-column: 1 / span 2;">
          <label for="weeklyFocus">Weekly focus area</label>
          <select id="weeklyFocus">
            <option value="vibrant_learning">Vibrant Learning (Real-World, Interdisciplinary Learning)</option>
            <option value="priority_standards">Priority Standards and Proficiency Scales</option>
            <option value="bim_workshop">BRIDGE Instructional Model (Workshop Model)</option>
            <option value="bpa">BRIDGE Performance Assessments (BPAs)</option>
            <option value="bpi_websites">BRIDGE Performance Indicators and Student BPI Websites</option>
            <option value="wac">Writing Across the Content (WAC)</option>
            <option value="compelling_evidence">Compelling Evidence and Local Accountability</option>
          </select>
        </div>

        <div class="field">
          <label for="submitterRole">Role</label>
          <select id="submitterRole">
            <option value="Principal">Principal</option>
            <option value="District Leader">District Leader</option>
            <option value="Director">Director</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="field">
          <label for="submitterName">Name</label>
          <input id="submitterName" type="text" placeholder="First Last"/>
        </div>
      </div>

      <div class="tools">
        <button class="btn gold" id="saveLocalBtn">Save local</button>
        <button class="btn secondary" id="printBtn">Print</button>
        <button class="btn secondary" id="exportBtn">Export JSON</button>
        <label class="btn secondary" style="display:inline-flex; align-items:center; gap:8px;">
          Import JSON
          <input id="importFile" type="file" accept="application/json" style="display:none;">
        </label>
        <button class="btn danger" id="resetBtn">Reset</button>
      </div>

      <div class="tools">
        <button class="btn" id="submitToSheetBtn">Submit to Google Sheet</button>
        <button class="btn secondary" id="refreshAnalyticsBtn">Refresh analytics</button>
      </div>

      <!-- MOVED HERE: Collapsible Analytics under left submit buttons -->
      <details class="analytics" id="analyticsPanel" open>
        <summary>
          <div class="analyticsTitle">
            <div class="t">School vs District Analytics</div>
            <div class="d">Current week and YTD. Updates when week or school changes.</div>
          </div>
          <div class="chev">^</div>
        </summary>

        <div class="analyticsBody">
          <div class="chartsGrid">
            <div class="chartCard">
              <div class="label">Current week status mix</div>
              <div class="hint">School and District counts for Green, Yellow, Red.</div>
              <canvas id="pieCurrent"></canvas>
            </div>

            <div class="chartCard">
              <div class="label">YTD status mix</div>
              <div class="hint">School and District counts for Green, Yellow, Red.</div>
              <canvas id="pieYtd"></canvas>
            </div>

            <div class="chartCard">
              <div class="label">Current week average score</div>
              <div class="hint">Green=3, Yellow=2, Red=1. School vs District.</div>
              <canvas id="barCurrent"></canvas>
            </div>

            <div class="chartCard">
              <div class="label">YTD average score</div>
              <div class="hint">Green=3, Yellow=2, Red=1. School vs District.</div>
              <canvas id="barYtd"></canvas>
            </div>
          </div>

          <div class="footerNote" style="margin-top:10px;">
            Blank or near-zero charts usually mean no submissions yet for that slice.
          </div>
        </div>
      </details>

      <div class="footerNote">
        Yellow or Red requires a clear plan, owner, due date, and help needed.
      </div>
    </aside>

    <main class="content">
      <div class="topbar">
        <div>
          <h2 id="pageTitle">Loading...</h2>
          <div class="context" id="pageContext"></div>
        </div>

        <div style="min-width:280px;">
          <div class="card" style="padding:14px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:12px;">
              <div>
                <div style="font-weight:900; font-size:13px;">Status</div>
                <div class="muted">Must match evidence.</div>
              </div>
              <div class="pill" id="completionPill">0% complete</div>
            </div>

            <div class="inline" style="margin-top:10px;">
              <span class="statusDot" id="statusDot"></span>
              <select id="statusSelect">
                <option value="green">Green (on track)</option>
                <option value="yellow">Yellow (at risk, plan in place)</option>
                <option value="red">Red (off track, need help)</option>
              </select>
            </div>

            <div class="laneRow">
              <div>
                <label>Key metric 1</label>
                <input id="metric1" type="text" placeholder="Example: % evidence updated"/>
              </div>
              <div>
                <label>Key metric 2</label>
                <input id="metric2" type="text" placeholder="Example: BPA calibration done"/>
              </div>
              <div>
                <label>Key metric 3</label>
                <input id="metric3" type="text" placeholder="Example: WAC artifacts published"/>
              </div>
            </div>

            <div style="margin-top:10px;">
              <label>Lane owner</label>
              <input id="laneOwner" type="text" placeholder="Name"/>
            </div>
          </div>
        </div>
      </div>

      <div class="grid">
        <section class="card">
          <div class="cardHeader">
            <div>
              <h3>Core Framing Questions (Every Area, Every Week)</h3>
              <div class="muted">Added RYG per question so leaders can see where clarity is strong or weak.</div>
            </div>
            <div class="pill" id="coreDonePill">0/0 answered</div>
          </div>
          <div class="qList" id="coreQuestions"></div>
        </section>

        <section class="card">
          <div class="cardHeader">
            <div>
              <h3 id="focusTitle">Weekly Focus Questions</h3>
              <div class="muted" id="focusHint"></div>
            </div>
            <div class="pill" id="focusDonePill">0/0 answered</div>
          </div>
          <div class="qList" id="focusQuestions"></div>
        </section>

        <section class="card">
          <div class="cardHeader">
            <div>
              <h3>Closing Question</h3>
              <div class="muted">Always last.</div>
            </div>
            <div class="pill" id="closeDonePill">Not answered</div>
          </div>
          <div class="qList" id="closingQuestion"></div>
        </section>
      </div>
    </main>
  </div>

<script>
  // ====== CONFIG ======
  const SCRIPT_URL = "https://script.google.com/a/macros/fleming.kyschools.us/s/AKfycbzNVN8AiQzPBzE1CMdDzy9bWGzlq9_p4qALlzwuEDkUxIzazgIHK70pS61nswTX0T_B6w/exec";
  const STORAGE_KEY = "fcs_weekly_exec_review_clean_sidebar_analytics_v1";

  // ====== QUESTIONS ======
  const CORE_FRAMING_QUESTIONS = [
    { id:"plan", prompt:"What is the plan for this area of focus? If the plan cannot be stated in two to three sentences, it is not clear enough yet.", tip:"Write it as a tight plan statement. If it is long, it is not clear yet." },
    { id:"happened", prompt:"What actually happened this week? Not what was intended, not what is usually true. What evidence shows what students and classrooms experienced.", tip:"Name specific evidence. Student work, walkthrough notes, BPI artifacts, BPA products, WAC samples." },
    { id:"status_why", prompt:"Are we on track, at risk, or off track? Why? Status must be tied directly to observable evidence, not perception.", tip:"If you cannot cite evidence, stay Yellow until the evidence is real." },
    { id:"threat", prompt:"What is the one thing that most threatens progress right now?", tip:"One thing. Not five." },
    { id:"address", prompt:"What is the plan to address it? Who owns it, what is changing next week, and how will we know it worked.", tip:"Owner + next step + success signal." },
    { id:"help", prompt:"Where do you need help? Leaders are expected to ask for help early, not after failure.", tip:"Be explicit: decision needed, support needed, barrier removal." }
  ];

  const CLOSING_QUESTION = {
    id:"closing",
    prompt:"If we sit here next Monday, what would have to change for you to confidently say we are moving forward?",
    tip:"Say what must be different in observable terms."
  };

  const FOCUS_META = {
    vibrant_learning: { title:"Vibrant Learning (Real-World, Interdisciplinary Learning)", hint:"Visibility beats vibes. Name what students did and what they produced." },
    priority_standards: { title:"Priority Standards and Proficiency Scales", hint:"If standards are not visible, alignment is not real." },
    bim_workshop: { title:"BRIDGE Instructional Model (Workshop Model)", hint:"Process discipline matters. Show what was done and what improved." },
    bpa: { title:"BRIDGE Performance Assessments (BPAs)", hint:"Results must match intent. Show products and rubric evidence." },
    bpi_websites: { title:"BRIDGE Performance Indicators and Student BPI Websites", hint:"Evidence has to be published and current, or it cannot function as accountability." },
    wac: { title:"Writing Across the Content (WAC)", hint:"Writing should deepen thinking, not just document work." },
    compelling_evidence: { title:"Compelling Evidence and Local Accountability", hint:"Conflicts between data and artifacts are signals, not problems to hide." }
  };

  const FOCUS_QUESTIONS = {
    vibrant_learning: [
      { id:"rw_context", prompt:"Where did students apply learning to a real-world context this week?", tip:"Name the real context and the student product." },
      { id:"thinking_evidence", prompt:"What evidence shows students were thinking, not just completing tasks?", tip:"Look for reasoning, explanation, revision, transfer." },
      { id:"bright_spots", prompt:"Which classrooms best represent our vision of vibrant learning right now?", tip:"Name the bright spots and what we can learn from them." }
    ],
    priority_standards: [
      { id:"visible_standards", prompt:"Which priority standards were most visible in classrooms this week?", tip:"Name 1-3 standards and where they showed up." },
      { id:"mastery_evidence", prompt:"How do we know students were working toward mastery of those standards?", tip:"Cite evidence. What did students do that proves it." },
      { id:"student_explain", prompt:"What evidence shows students can explain where they are on the scale?", tip:"Student explanation is the signal, not teacher opinion." }
    ],
    bim_workshop: [
      { id:"model_visible", prompt:"Where did the Workshop Model clearly drive learning this week?", tip:"Point to mini-lesson, workshop, conferring, debrief evidence." },
      { id:"mini_lesson_align", prompt:"What evidence shows mini-lessons were aligned to priority standards?", tip:"Alignment is visible in target, task, and feedback." },
      { id:"fidelity_adjust", prompt:"What is one concrete adjustment being made to strengthen fidelity?", tip:"One change next week, and one signal you will check." }
    ],
    bpa: [
      { id:"in_progress", prompt:"Which BPAs were in progress or completed this week?", tip:"Name the BPA(s) and where they are in the process." },
      { id:"alignment", prompt:"What evidence shows alignment to standards and durable skills?", tip:"Rubric and student products must match the standards." },
      { id:"support_needed", prompt:"What support is needed to strengthen quality or consistency?", tip:"Calibration, exemplars, rubric tuning, coaching, time." }
    ],
    bpi_websites: [
      { id:"new_evidence", prompt:"What new evidence was added to student BPI websites this week?", tip:"Name what was added and what it shows." },
      { id:"growth_over_time", prompt:"How does that evidence show growth, mastery, or readiness over time?", tip:"Compare over time, not a single artifact." },
      { id:"thin_evidence", prompt:"Where is evidence thin, unclear, or missing?", tip:"Name the evidence gaps so next steps are obvious." }
    ],
    wac: [
      { id:"explain_thinking", prompt:"Where did students write to explain thinking, not just respond?", tip:"Look for explanation, justification, and reasoning." },
      { id:"deepen_understanding", prompt:"What evidence shows writing deepened understanding of content?", tip:"Writing should improve thinking, not just record it." },
      { id:"authentic_comm", prompt:"How are students using writing to communicate learning authentically?", tip:"Audience, purpose, revision, publishing are strong signals." }
    ],
    compelling_evidence: [
      { id:"best_evidence", prompt:"What evidence best represents the reality of learning this week?", tip:"Pick the evidence that tells the truth, not the most flattering." },
      { id:"conflict", prompt:"Where do sources conflict, and why?", tip:"Conflicts show where the system is unclear." },
      { id:"next_lookfors", prompt:"What will we look for next week to confirm progress?", tip:"Define the next signal." }
    ]
  };

  // ====== STATE ======
  function defaultState(){
    const today = new Date();
    const iso = new Date(today.getTime() - today.getTimezoneOffset()*60000).toISOString().slice(0,10);
    return {
      meta: {
        weekOf: iso,
        viewMode: "prep",
        orgLevel: "School",
        school: "Fleming Co. HS",
        submitterRole: "Principal",
        submitterName: "",
        weeklyFocus: "vibrant_learning"
      },
      status: {
        status: "green",
        metric1: "",
        metric2: "",
        metric3: "",
        laneOwner: ""
      },
      answers: {
        core: {},
        focus: {},
        closing: {}
      }
    };
  }

  let state = loadState();

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultState();
      const parsed = JSON.parse(raw);
      return { ...defaultState(), ...parsed };
    }catch(e){
      return defaultState();
    }
  }

  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function escapeHtml(str){
    return String(str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function statusClass(s){
    if(s === "green") return "green";
    if(s === "yellow") return "yellow";
    if(s === "red") return "red";
    return "";
  }

  function updateStatusDot(){
    const dot = document.getElementById("statusDot");
    dot.className = "statusDot " + statusClass(state.status.status);
  }

  function setSchoolVisibility(){
    const org = document.getElementById("orgLevel").value;
    document.getElementById("schoolField").style.display = (org === "School") ? "block" : "none";
  }

  // ====== CORE RYG PER QUESTION ======
  function ensureQMeta(bucket, qid){
    state.answers[bucket] = state.answers[bucket] || {};
    state.answers[bucket][qid] = state.answers[bucket][qid] || { text:"", qStatus:"green" };
    if(!state.answers[bucket][qid].qStatus) state.answers[bucket][qid].qStatus = "green";
    return state.answers[bucket][qid];
  }

  // ====== RENDER QUESTIONS ======
  function renderQuestionList(containerId, bucket, questions, allowRyg){
    const container = document.getElementById(containerId);
    container.innerHTML = "";

    questions.forEach(q => {
      const a = ensureQMeta(bucket, q.id);

      const el = document.createElement("div");
      el.className = "qItem";
      el.innerHTML = `
        <div class="qTop">
          <div>
            <div class="qPrompt">${escapeHtml(q.prompt)}</div>
            <div class="tip">Tip: ${escapeHtml(q.tip || "")}</div>
          </div>

          ${allowRyg ? `
            <div class="inline" style="gap:8px; align-items:center;">
              <span class="statusDot ${statusClass(a.qStatus)}"></span>
              <select data-action="qStatus" data-bucket="${bucket}" data-qid="${q.id}">
                <option value="green">Green</option>
                <option value="yellow">Yellow</option>
                <option value="red">Red</option>
              </select>
            </div>
          ` : ``}
        </div>

        <textarea class="qAnswer" data-bucket="${bucket}" data-qid="${q.id}" placeholder="Evidence-backed response."></textarea>
      `;

      container.appendChild(el);

      const ta = el.querySelector("textarea");
      ta.value = a.text || "";
      ta.addEventListener("input", () => {
        ensureQMeta(bucket, q.id).text = ta.value || "";
        saveState();
        updateAnsweredPills();
        updateCompletion();
      });

      if(allowRyg){
        const sel = el.querySelector('select[data-action="qStatus"]');
        sel.value = a.qStatus;
        sel.addEventListener("change", () => {
          ensureQMeta(bucket, q.id).qStatus = sel.value;
          saveState();
          const dot = sel.parentElement.querySelector(".statusDot");
          dot.className = "statusDot " + statusClass(sel.value);
        });
      }
    });

    updateAnsweredPills();
    updateCompletion();
  }

  function countAnswered(bucket, questions){
    let answered = 0;
    questions.forEach(q => {
      const a = ensureQMeta(bucket, q.id);
      if((a.text || "").trim().length > 0) answered += 1;
    });
    return { answered, total: questions.length };
  }

  function updateAnsweredPills(){
    const core = countAnswered("core", CORE_FRAMING_QUESTIONS);
    document.getElementById("coreDonePill").textContent = `${core.answered}/${core.total} answered`;

    const focusQs = FOCUS_QUESTIONS[state.meta.weeklyFocus] || [];
    const focus = countAnswered("focus", focusQs);
    document.getElementById("focusDonePill").textContent = `${focus.answered}/${focus.total} answered`;

    const closing = ensureQMeta("closing", "closing");
    document.getElementById("closeDonePill").textContent =
      (closing.text || "").trim().length ? "Answered" : "Not answered";
  }

  function updateCompletion(){
    const focusQs = FOCUS_QUESTIONS[state.meta.weeklyFocus] || [];
    const core = countAnswered("core", CORE_FRAMING_QUESTIONS);
    const focus = countAnswered("focus", focusQs);
    const closing = ensureQMeta("closing", "closing");
    const closingAnswered = (closing.text || "").trim().length ? 1 : 0;

    const total = core.total + focus.total + 1;
    const done = core.answered + focus.answered + closingAnswered;
    const pct = total ? Math.round((done/total)*100) : 0;
    document.getElementById("completionPill").textContent = `${pct}% complete`;
  }

  // ====== CHARTS ======
  let charts = { pieCurrent:null, pieYtd:null, barCurrent:null, barYtd:null };

  function statusToScore(s){
    s = String(s || "").toLowerCase();
    if(s === "green") return 3;
    if(s === "yellow") return 2;
    if(s === "red") return 1;
    return 0;
  }

  async function fetchAllRows(){
    const res = await fetch(SCRIPT_URL, { method:"GET" });
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || "Failed to load rows");
    return data.rows || [];
  }

  function parseDateMaybe(d){
    const dt = new Date(d);
    return isNaN(dt.getTime()) ? null : dt;
  }

  function isYtd(r){
    const ts = parseDateMaybe(r.timestamp_iso) || parseDateMaybe(r.week_of);
    if(!ts) return false;
    const y0 = new Date(new Date().getFullYear(), 0, 1);
    return ts >= y0;
  }

  function matchesWeek(r, weekOfIso){
    return String(r.week_of || "").slice(0,10) === String(weekOfIso || "").slice(0,10);
  }
  function matchesSchoolRow(r, schoolName){
    return (r.org_level === "School" && (r.school || "") === schoolName);
  }
  function matchesDistrictRow(r){
    return (r.org_level === "District");
  }

  function statusCounts(rows){
    const c = { green:0, yellow:0, red:0 };
    rows.forEach(r => {
      const s = String(r.status || "").toLowerCase();
      if(c[s] !== undefined) c[s] += 1;
    });
    return c;
  }

  function avgScore(rows){
    if(!rows.length) return 0;
    const sum = rows.reduce((a,r) => a + statusToScore(r.status), 0);
    return sum / rows.length;
  }

  function ensureChart(canvasEl, existing, type, data, options){
    const ctx = canvasEl.getContext("2d");
    if(existing){
      existing.data = data;
      existing.options = options;
      existing.update();
      return existing;
    }
    return new Chart(ctx, { type, data, options });
  }

  async function refreshAnalytics(){
    let rows = [];
    try{
      rows = await fetchAllRows();
    }catch(e){
      rows = [];
    }

    const schoolName = state.meta.school;
    const weekOf = state.meta.weekOf;

    const schoolWeek = rows.filter(r => matchesSchoolRow(r, schoolName) && matchesWeek(r, weekOf));
    const districtWeek = rows.filter(r => matchesDistrictRow(r) && matchesWeek(r, weekOf));

    const schoolYtd = rows.filter(r => matchesSchoolRow(r, schoolName) && isYtd(r));
    const districtYtd = rows.filter(r => matchesDistrictRow(r) && isYtd(r));

    const sw = statusCounts(schoolWeek);
    const dw = statusCounts(districtWeek);
    const sy = statusCounts(schoolYtd);
    const dy = statusCounts(districtYtd);

    const swAvg = avgScore(schoolWeek);
    const dwAvg = avgScore(districtWeek);
    const syAvg = avgScore(schoolYtd);
    const dyAvg = avgScore(districtYtd);

    const pieOpts = {
      responsive:true,
      animation: { duration: 650 },
      plugins: { legend: { display:false } }
    };

    charts.pieCurrent = ensureChart(
      document.getElementById("pieCurrent"),
      charts.pieCurrent,
      "pie",
      {
        labels: ["School Green","School Yellow","School Red","District Green","District Yellow","District Red"],
        datasets: [{ data: [sw.green, sw.yellow, sw.red, dw.green, dw.yellow, dw.red] }]
      },
      pieOpts
    );

    charts.pieYtd = ensureChart(
      document.getElementById("pieYtd"),
      charts.pieYtd,
      "pie",
      {
        labels: ["School Green","School Yellow","School Red","District Green","District Yellow","District Red"],
        datasets: [{ data: [sy.green, sy.yellow, sy.red, dy.green, dy.yellow, dy.red] }]
      },
      pieOpts
    );

    const barOpts = {
      responsive:true,
      animation: { duration: 650 },
      scales: { y: { beginAtZero:true, suggestedMax:3 } },
      plugins: { legend: { display:false } }
    };

    charts.barCurrent = ensureChart(
      document.getElementById("barCurrent"),
      charts.barCurrent,
      "bar",
      { labels: ["School", "District"], datasets: [{ label:"Avg score", data: [swAvg, dwAvg] }] },
      barOpts
    );

    charts.barYtd = ensureChart(
      document.getElementById("barYtd"),
      charts.barYtd,
      "bar",
      { labels: ["School YTD", "District YTD"], datasets: [{ label:"Avg score", data: [syAvg, dyAvg] }] },
      barOpts
    );
  }

  // ====== SUBMIT ======
  function buildSubmissionPayload(){
    const focusId = state.meta.weeklyFocus;
    const focusTitle = FOCUS_META[focusId]?.title || focusId;

    const core_answers = {};
    CORE_FRAMING_QUESTIONS.forEach(q => core_answers[q.id] = ensureQMeta("core", q.id));
    const focus_answers = {};
    (FOCUS_QUESTIONS[focusId] || []).forEach(q => focus_answers[q.id] = ensureQMeta("focus", q.id));
    const closing_answers = { closing: ensureQMeta("closing", "closing") };

    return {
      week_of: state.meta.weekOf,
      view_mode: state.meta.viewMode,
      org_level: state.meta.orgLevel,
      school: state.meta.orgLevel === "School" ? state.meta.school : "District",
      submitter_name: state.meta.submitterName,
      submitter_role: state.meta.submitterRole,
      weekly_focus_area_id: focusId,
      weekly_focus_area_title: focusTitle,

      status: state.status.status,
      metric1: state.status.metric1,
      metric2: state.status.metric2,
      metric3: state.status.metric3,
      lane_owner: state.status.laneOwner,

      core_answers,
      focus_answers,
      closing_answers
    };
  }

  async function submitToSheet(){
    const payload = buildSubmissionPayload();
    const btn = document.getElementById("submitToSheetBtn");
    btn.disabled = true;
    btn.textContent = "Submitting...";

    try{
      const res = await fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || "Submit failed.");
      alert("Submitted to Google Sheet.");
      await refreshAnalytics();
    }catch(err){
      alert("Submit failed: " + String(err));
    }finally{
      btn.disabled = false;
      btn.textContent = "Submit to Google Sheet";
    }
  }

  // ====== PAGE RENDER ======
  function renderPage(){
    weekOf.value = state.meta.weekOf;
    viewMode.value = state.meta.viewMode;
    orgLevel.value = state.meta.orgLevel;
    schoolSelect.value = state.meta.school;
    submitterRole.value = state.meta.submitterRole;
    submitterName.value = state.meta.submitterName;
    weeklyFocus.value = state.meta.weeklyFocus;

    setSchoolVisibility();

    statusSelect.value = state.status.status;
    metric1.value = state.status.metric1;
    metric2.value = state.status.metric2;
    metric3.value = state.status.metric3;
    laneOwner.value = state.status.laneOwner;

    updateStatusDot();

    const focusId = state.meta.weeklyFocus;
    const meta = FOCUS_META[focusId];

    pageTitle.textContent = `Weekly Focus: ${meta ? meta.title : "Focus Area"}`;
    pageContext.textContent =
      "Charts are in the left sidebar for quick context while you complete the weekly executive review. Change the week or school to update School vs District charts (current week and YTD).";

    focusTitle.textContent = `Weekly Focus Questions: ${meta ? meta.title : ""}`;
    focusHint.textContent = meta ? meta.hint : "";

    renderQuestionList("coreQuestions", "core", CORE_FRAMING_QUESTIONS, true);
    renderQuestionList("focusQuestions", "focus", FOCUS_QUESTIONS[focusId] || [], false);
    renderQuestionList("closingQuestion", "closing", [CLOSING_QUESTION], false);

    refreshAnalytics();
  }

  // ====== WIRES ======
  function wireMeta(){
    const bind = (id, fn, evt="change") => document.getElementById(id).addEventListener(evt, fn);

    bind("weekOf", async () => { state.meta.weekOf = weekOf.value; saveState(); await refreshAnalytics(); });
    bind("viewMode", () => { state.meta.viewMode = viewMode.value; saveState(); });
    bind("orgLevel", async () => { state.meta.orgLevel = orgLevel.value; setSchoolVisibility(); saveState(); await refreshAnalytics(); });

    bind("schoolSelect", async () => { state.meta.school = schoolSelect.value; saveState(); await refreshAnalytics(); });

    bind("weeklyFocus", () => { state.meta.weeklyFocus = weeklyFocus.value; saveState(); renderPage(); });

    bind("submitterRole", () => { state.meta.submitterRole = submitterRole.value; saveState(); });

    submitterName.addEventListener("input", () => { state.meta.submitterName = submitterName.value; saveState(); });

    bind("statusSelect", () => { state.status.status = statusSelect.value; saveState(); updateStatusDot(); });
    ["metric1","metric2","metric3","laneOwner"].forEach(id => {
      document.getElementById(id).addEventListener("input", () => {
        state.status[id === "laneOwner" ? "laneOwner" : id] = document.getElementById(id).value;
        saveState();
      });
    });
  }

  function wireButtons(){
    saveLocalBtn.addEventListener("click", () => { saveState(); alert("Saved locally."); });
    printBtn.addEventListener("click", () => { saveState(); window.print(); });

    exportBtn.addEventListener("click", () => {
      saveState();
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `FCS_Weekly_Executive_Review_${state.meta.weekOf || "week"}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    importFile.addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      e.target.value = "";
      if(!file) return;
      try{
        const text = await file.text();
        const parsed = JSON.parse(text);
        state = { ...defaultState(), ...parsed };
        saveState();
        renderPage();
        alert("Imported.");
      }catch(err){
        alert("Import failed: " + String(err));
      }
    });

    resetBtn.addEventListener("click", () => {
      if(!confirm("Reset everything to defaults for this device?")) return;
      state = defaultState();
      saveState();
      renderPage();
    });

    submitToSheetBtn.addEventListener("click", submitToSheet);
    refreshAnalyticsBtn.addEventListener("click", refreshAnalytics);
  }

  // ====== INIT ======
  wireMeta();
  wireButtons();
  renderPage();
</script>
</body>
</html>
